<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>WASM 在动画引擎中的设计优化 | 日常收集</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/book/assets/css/0.styles.0575b83d.css" as="style"><link rel="preload" href="/book/assets/js/app.c8cf2c2d.js" as="script"><link rel="preload" href="/book/assets/js/3.0d5fb1e8.js" as="script"><link rel="preload" href="/book/assets/js/144.662af319.js" as="script"><link rel="preload" href="/book/assets/js/4.4c5f7830.js" as="script"><link rel="prefetch" href="/book/assets/js/10.b7e4165a.js"><link rel="prefetch" href="/book/assets/js/100.ff8b475f.js"><link rel="prefetch" href="/book/assets/js/101.19bef30c.js"><link rel="prefetch" href="/book/assets/js/102.9f2e224b.js"><link rel="prefetch" href="/book/assets/js/103.6dd6e411.js"><link rel="prefetch" href="/book/assets/js/104.29cb43a7.js"><link rel="prefetch" href="/book/assets/js/105.bea4dd2d.js"><link rel="prefetch" href="/book/assets/js/106.5a045c6a.js"><link rel="prefetch" href="/book/assets/js/107.24dfb0a1.js"><link rel="prefetch" href="/book/assets/js/108.faf80b69.js"><link rel="prefetch" href="/book/assets/js/109.c40b51b2.js"><link rel="prefetch" href="/book/assets/js/11.44217601.js"><link rel="prefetch" href="/book/assets/js/110.0ad5bafa.js"><link rel="prefetch" href="/book/assets/js/111.c85d723e.js"><link rel="prefetch" href="/book/assets/js/112.b8d99964.js"><link rel="prefetch" href="/book/assets/js/113.7b01d741.js"><link rel="prefetch" href="/book/assets/js/114.40924aed.js"><link rel="prefetch" href="/book/assets/js/115.73705314.js"><link rel="prefetch" href="/book/assets/js/116.2722c552.js"><link rel="prefetch" href="/book/assets/js/117.d5ea400e.js"><link rel="prefetch" href="/book/assets/js/118.8f552084.js"><link rel="prefetch" href="/book/assets/js/119.05f11ec8.js"><link rel="prefetch" href="/book/assets/js/12.571f12ac.js"><link rel="prefetch" href="/book/assets/js/120.7ac63c38.js"><link rel="prefetch" href="/book/assets/js/121.addba4bc.js"><link rel="prefetch" href="/book/assets/js/122.e36ab092.js"><link rel="prefetch" href="/book/assets/js/123.f768b115.js"><link rel="prefetch" href="/book/assets/js/124.88cc6bb2.js"><link rel="prefetch" href="/book/assets/js/125.3086a6c7.js"><link rel="prefetch" href="/book/assets/js/126.8685f3d1.js"><link rel="prefetch" href="/book/assets/js/127.a2e54fa3.js"><link rel="prefetch" href="/book/assets/js/128.05dd1ef5.js"><link rel="prefetch" href="/book/assets/js/129.8d61cdc3.js"><link rel="prefetch" href="/book/assets/js/13.94f0d951.js"><link rel="prefetch" href="/book/assets/js/130.6894001e.js"><link rel="prefetch" href="/book/assets/js/131.3b56b34d.js"><link rel="prefetch" href="/book/assets/js/132.de4f4a7c.js"><link rel="prefetch" href="/book/assets/js/133.f22a0818.js"><link rel="prefetch" href="/book/assets/js/134.39fc556b.js"><link rel="prefetch" href="/book/assets/js/135.674da456.js"><link rel="prefetch" href="/book/assets/js/136.33860124.js"><link rel="prefetch" href="/book/assets/js/137.2c19d3fa.js"><link rel="prefetch" href="/book/assets/js/138.c402dab0.js"><link rel="prefetch" href="/book/assets/js/139.5e82f303.js"><link rel="prefetch" href="/book/assets/js/14.3d533f57.js"><link rel="prefetch" href="/book/assets/js/140.62e0cb58.js"><link rel="prefetch" href="/book/assets/js/141.fa154467.js"><link rel="prefetch" href="/book/assets/js/142.778347a5.js"><link rel="prefetch" href="/book/assets/js/143.9c54f61b.js"><link rel="prefetch" href="/book/assets/js/145.5944e1fc.js"><link rel="prefetch" href="/book/assets/js/146.fd43269d.js"><link rel="prefetch" href="/book/assets/js/147.c84266c4.js"><link rel="prefetch" href="/book/assets/js/148.dbc94a8a.js"><link rel="prefetch" href="/book/assets/js/149.b9372d26.js"><link rel="prefetch" href="/book/assets/js/15.281fe50b.js"><link rel="prefetch" href="/book/assets/js/150.37570d27.js"><link rel="prefetch" href="/book/assets/js/151.d1827480.js"><link rel="prefetch" href="/book/assets/js/152.fbcaf5cb.js"><link rel="prefetch" href="/book/assets/js/153.3776cdba.js"><link rel="prefetch" href="/book/assets/js/154.e1f55cec.js"><link rel="prefetch" href="/book/assets/js/155.4669a8c6.js"><link rel="prefetch" href="/book/assets/js/156.458405bf.js"><link rel="prefetch" href="/book/assets/js/157.d95c27d1.js"><link rel="prefetch" href="/book/assets/js/158.e0bc050f.js"><link rel="prefetch" href="/book/assets/js/159.143f4e35.js"><link rel="prefetch" href="/book/assets/js/16.c05e6974.js"><link rel="prefetch" href="/book/assets/js/160.5ab2a46a.js"><link rel="prefetch" href="/book/assets/js/161.24b0ff2e.js"><link rel="prefetch" href="/book/assets/js/162.ae6079c0.js"><link rel="prefetch" href="/book/assets/js/163.137cde9d.js"><link rel="prefetch" href="/book/assets/js/164.b805d4a1.js"><link rel="prefetch" href="/book/assets/js/165.31686672.js"><link rel="prefetch" href="/book/assets/js/166.fb140ab0.js"><link rel="prefetch" href="/book/assets/js/167.f41765a0.js"><link rel="prefetch" href="/book/assets/js/168.0573b984.js"><link rel="prefetch" href="/book/assets/js/169.6877c1df.js"><link rel="prefetch" href="/book/assets/js/17.98e34aaf.js"><link rel="prefetch" href="/book/assets/js/170.948c455c.js"><link rel="prefetch" href="/book/assets/js/18.51ea57a3.js"><link rel="prefetch" href="/book/assets/js/19.8ba7ecb7.js"><link rel="prefetch" href="/book/assets/js/20.428d3741.js"><link rel="prefetch" href="/book/assets/js/21.6229732b.js"><link rel="prefetch" href="/book/assets/js/22.aaf4eec1.js"><link rel="prefetch" href="/book/assets/js/23.3c002936.js"><link rel="prefetch" href="/book/assets/js/24.bd9616e3.js"><link rel="prefetch" href="/book/assets/js/25.13ac73ab.js"><link rel="prefetch" href="/book/assets/js/26.87ee90df.js"><link rel="prefetch" href="/book/assets/js/27.2e41022a.js"><link rel="prefetch" href="/book/assets/js/28.47dbd3dd.js"><link rel="prefetch" href="/book/assets/js/29.f9a72fbb.js"><link rel="prefetch" href="/book/assets/js/30.f25cdd9c.js"><link rel="prefetch" href="/book/assets/js/31.efc3f08d.js"><link rel="prefetch" href="/book/assets/js/32.5dcd7f59.js"><link rel="prefetch" href="/book/assets/js/33.8760ca3a.js"><link rel="prefetch" href="/book/assets/js/34.fa9fc2e4.js"><link rel="prefetch" href="/book/assets/js/35.b1a81b64.js"><link rel="prefetch" href="/book/assets/js/36.dcb0e8e4.js"><link rel="prefetch" href="/book/assets/js/37.f208f46d.js"><link rel="prefetch" href="/book/assets/js/38.749c6353.js"><link rel="prefetch" href="/book/assets/js/39.c79b7b8d.js"><link rel="prefetch" href="/book/assets/js/40.e57f0567.js"><link rel="prefetch" href="/book/assets/js/41.b7de65dc.js"><link rel="prefetch" href="/book/assets/js/42.a4199118.js"><link rel="prefetch" href="/book/assets/js/43.29627dcd.js"><link rel="prefetch" href="/book/assets/js/44.4fd40982.js"><link rel="prefetch" href="/book/assets/js/45.f9ca9392.js"><link rel="prefetch" href="/book/assets/js/46.224d749a.js"><link rel="prefetch" href="/book/assets/js/47.46212b48.js"><link rel="prefetch" href="/book/assets/js/48.b4530c84.js"><link rel="prefetch" href="/book/assets/js/49.c5ce825f.js"><link rel="prefetch" href="/book/assets/js/5.eefbb6d1.js"><link rel="prefetch" href="/book/assets/js/50.abb4615c.js"><link rel="prefetch" href="/book/assets/js/51.2bad13e4.js"><link rel="prefetch" href="/book/assets/js/52.a281d464.js"><link rel="prefetch" href="/book/assets/js/53.d932d947.js"><link rel="prefetch" href="/book/assets/js/54.14345852.js"><link rel="prefetch" href="/book/assets/js/55.3188a009.js"><link rel="prefetch" href="/book/assets/js/56.e16829eb.js"><link rel="prefetch" href="/book/assets/js/57.53dea087.js"><link rel="prefetch" href="/book/assets/js/58.538898c1.js"><link rel="prefetch" href="/book/assets/js/59.b7d7c110.js"><link rel="prefetch" href="/book/assets/js/6.18aff54a.js"><link rel="prefetch" href="/book/assets/js/60.1e7dcd20.js"><link rel="prefetch" href="/book/assets/js/61.f13068fe.js"><link rel="prefetch" href="/book/assets/js/62.0a4e1149.js"><link rel="prefetch" href="/book/assets/js/63.431914ad.js"><link rel="prefetch" href="/book/assets/js/64.df81dce3.js"><link rel="prefetch" href="/book/assets/js/65.6143b870.js"><link rel="prefetch" href="/book/assets/js/66.f9abed3f.js"><link rel="prefetch" href="/book/assets/js/67.3397cfbe.js"><link rel="prefetch" href="/book/assets/js/68.bf72bbf4.js"><link rel="prefetch" href="/book/assets/js/69.e3a5531b.js"><link rel="prefetch" href="/book/assets/js/7.637d308b.js"><link rel="prefetch" href="/book/assets/js/70.e3c80238.js"><link rel="prefetch" href="/book/assets/js/71.e0711aa7.js"><link rel="prefetch" href="/book/assets/js/72.13845c1b.js"><link rel="prefetch" href="/book/assets/js/73.a982a8ed.js"><link rel="prefetch" href="/book/assets/js/74.22bbccf1.js"><link rel="prefetch" href="/book/assets/js/75.d22833f1.js"><link rel="prefetch" href="/book/assets/js/76.6cdfacdd.js"><link rel="prefetch" href="/book/assets/js/77.c715bf8d.js"><link rel="prefetch" href="/book/assets/js/78.c77b50af.js"><link rel="prefetch" href="/book/assets/js/79.2f968e4e.js"><link rel="prefetch" href="/book/assets/js/8.3201113b.js"><link rel="prefetch" href="/book/assets/js/80.5e7ab955.js"><link rel="prefetch" href="/book/assets/js/81.2e117c7b.js"><link rel="prefetch" href="/book/assets/js/82.1f9856a9.js"><link rel="prefetch" href="/book/assets/js/83.22728db6.js"><link rel="prefetch" href="/book/assets/js/84.c28a521e.js"><link rel="prefetch" href="/book/assets/js/85.473f6b95.js"><link rel="prefetch" href="/book/assets/js/86.e4b6adfa.js"><link rel="prefetch" href="/book/assets/js/87.d46fb7cf.js"><link rel="prefetch" href="/book/assets/js/88.18a2b0e0.js"><link rel="prefetch" href="/book/assets/js/89.9ee67c4a.js"><link rel="prefetch" href="/book/assets/js/9.5cf4899a.js"><link rel="prefetch" href="/book/assets/js/90.3b188a59.js"><link rel="prefetch" href="/book/assets/js/91.e8768301.js"><link rel="prefetch" href="/book/assets/js/92.19241f7a.js"><link rel="prefetch" href="/book/assets/js/93.bc96ef51.js"><link rel="prefetch" href="/book/assets/js/94.dd590ff1.js"><link rel="prefetch" href="/book/assets/js/95.884ed018.js"><link rel="prefetch" href="/book/assets/js/96.a5548eaf.js"><link rel="prefetch" href="/book/assets/js/97.f5d876cb.js"><link rel="prefetch" href="/book/assets/js/98.5f912987.js"><link rel="prefetch" href="/book/assets/js/99.a74b7e4e.js"><link rel="prefetch" href="/book/assets/js/vendors~docsearch.c8693219.js">
    <link rel="stylesheet" href="/book/assets/css/0.styles.0575b83d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/book/" class="home-link router-link-active"><!----> <span class="site-name">日常收集</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>dom的事件</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/book/291.html" class="sidebar-link">Javascript事件捕获与事件冒泡</a></li><li><a href="/book/194.html" class="sidebar-link">DOM 事件流（event flow ）存在三个阶段：**事件捕获阶段、处于目标阶段、事件冒泡阶段。**</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Javascript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>element-ui</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Qcanvas</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/book/365.html" aria-current="page" class="active sidebar-link"> WASM 在动画引擎中的设计优化</a></li><li><a href="/book/364.html" class="sidebar-link"> 你管这破玩意叫指针？</a></li><li><a href="/book/362.html" class="sidebar-link"> 图说 WebAssembly</a></li><li><a href="/book/328.html" class="sidebar-link"> 从哲学层面浅谈计算机学习方法论</a></li><li><a href="/book/324.html" class="sidebar-link"> 微信游览器，解决安卓和ios自动播放音乐</a></li><li><a href="/book/323.html" class="sidebar-link"> CSS3 animation属性中的steps功能符深入介绍</a></li><li><a href="/book/322.html" class="sidebar-link"> 前端搞工程化：从零打造性能检测库「源码 + 视频」</a></li><li><a href="/book/321.html" class="sidebar-link"> 还在看那些老掉牙的性能优化文章么？这些最新性能指标了解下</a></li><li><a href="/book/320.html" class="sidebar-link"> Nginx根据User Agent动态配置root目录适配移动端</a></li><li><a href="/book/307.html" class="sidebar-link"> cat文档内容中搜索字符串输出到文件</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>node</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/book/301.html" class="sidebar-link">从App store下载App的不同版本ipa文件----很多东西也不是越新越好，比如APP——在 iPhone 上尤其如此</a></li><li><a href="/book/294.html" class="sidebar-link">迟子建老师的《一坛猪油》</a></li><li><a href="/book/288.html" class="sidebar-link">文本文档的协同编辑实现</a></li><li><a href="/book/287.html" class="sidebar-link">再见，整洁代码</a></li><li><a href="/book/286.html" class="sidebar-link"> 可以在 Nginx 中运行 JavaScript，厉害了！</a></li><li><a href="/book/284.html" class="sidebar-link"> word中批量调整图片大小</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>electron打包的一些问题</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/book/274.html" class="sidebar-link"> 文件分片代码</a></li><li><a href="/book/273.html" class="sidebar-link"> 重学 JS：为啥 await 不能用在 forEach 中详解</a></li><li><a href="/book/269.html" class="sidebar-link"> Excel函数之王，Vlookup到底怎么用？</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>mysql</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/book/248.html" class="sidebar-link"> 《提问的智慧》精读注解版</a></li><li><a href="/book/199.html" class="sidebar-link"> js监听div的resize事件</a></li><li><a href="/book/198.html" class="sidebar-link"> 引入第三方字体体积太大的问题</a></li><li><a href="/book/195.html" class="sidebar-link"> 多行溢出省略号显示（css/js）实现！</a></li><li><a href="/book/190.html" class="sidebar-link">今天带大家一起来看看下，如何实现“划词高亮”功能。</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Css</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Canvas</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工作中解决的疑难问题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>nginx</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/book/135.html" class="sidebar-link"> 深夜，我偷听到程序员要对session下手</a></li><li><a href="/book/132.html" class="sidebar-link"> 读 《深入浅出webpack》</a></li><li><a href="/book/103.html" class="sidebar-link"> 一道被人轻视的前端面试题</a></li><li><a href="/book/101.html" class="sidebar-link">部分前端面试题参考答案</a></li><li><a href="/book/80.html" class="sidebar-link">SVGDeveloper制作矢量地图教程详解</a></li><li><a href="/book/76.html" class="sidebar-link">VisualStudio2010创建的WCF（.dll）服务第一个应用</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="wasm-在动画引擎中的设计优化"><a href="#wasm-在动画引擎中的设计优化" class="header-anchor">#</a> WASM 在动画引擎中的设计优化</h1> <blockquote><p>‍♀️ 编者按：本文作者是蚂蚁集团前端工程师阿侎，探讨一个图形动画领域的性能优化：如何在 canvas/webgl 的动画引擎设计上，使用 WASM 来优化性能？</p></blockquote> <h1 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h1> <p>WebAssembly 技术日趋稳定和成熟，在许多场景下已经被运用，其重要特性之一的性能更是作为用来被解决问题的手段。</p> <p>关于其基础原理、适应场景等本文不再赘述。动画引擎本身原理这里也作为基础跳过不说。</p> <p>此篇主要探讨一个图形动画领域的性能优化：如何在 canvas/webgl 的动画引擎设计上，使用 WASM 来优化性能？</p> <p>让我们首先规定下动画引擎：</p> <blockquote><p>具备类似 CSS Animation / Web Animation Api 的完备功能，而非简单的帧时间计数器。</p></blockquote> <ol><li>这需要有暂停、恢复、变速、跳转、反向、取消、完成、轮播等一系列控制能力；</li> <li>更完整的是需要有简单 api，赋予一个类似 DOM 的对象任意动画功能的编程能力，可以入参；</li> <li>如果可以，最好支持 CSS 的单位（rem、vw）、停留模式、事件。</li></ol> <p>以上 3 点层级依次递增，根据完整度不同。</p> <p>第 1 点是基础，第 2 点较普遍，第 3 点比较苛刻可以有选择实现（和渲染强关联）。</p> <h1 id="特点"><a href="#特点" class="header-anchor">#</a> 特点</h1> <p>很多分享中都能见到，WASM 适合密集计算型，能提升相对原本 js 的小几倍。这对于渲染或动画来说已经很难得了。</p> <p>但是 WASM 需要规避频繁调用和数据交换，一帧一次渲染内 api 数据交互需要保证数量很少才行。这也和动画 api 的使用设计相关。如果没注意这个，可能最后性能的改进还不如数据交互消耗得多。</p> <p>比如动画每帧内的计算都在 WASM 内部完成，一帧中选取适合的时机一次性吐出。而初始化动画等行为是少数性甚至一次性操作，这个特点可以忽视掉，不会有调用次数过多场景。</p> <p>另：在实测中同时尝试了几种编程语言的 WASM 版本，最初很想用前端熟悉的 Assembly Script。但在性能测试中 AS 提升极为有限，甚至没啥区别。</p> <p>最终采用了 Rust：https://github.com/karasjs/wasm</p> <h1 id="限制"><a href="#限制" class="header-anchor">#</a> 限制</h1> <p>先说说限制。</p> <p>动画引擎和渲染引擎强关联，很多优化逻辑都要和渲染引擎绑定。</p> <p>动画的种类也有很多种，最常见的是 transform 和 opacity，无论是写 CSS 还是播放一段 Lottie，设计师最常用基础手段便是这 2 个。</p> <p>再比较常见一些的则是 visibility、color、border、z-index、font 等。</p> <p>再往后不是那么频繁的则是width、margin、perspective、路径、矢量形状等。</p> <p>这里不讨论高级或封装的如骨骼、粒子、shader 效果。</p> <p>如果这些全部用 WASM 来写，势必会有成本问题：</p> <ol><li>无论 C++ 还是 Rust 还是其它，编写难度成本都不容忽视；</li> <li>有些甚至是扩展成本，比如 font、width、路径、矢量动画，它和渲染引擎耦合极重，WASM 等于还要再实现一遍渲染逻辑；</li> <li>调试维护也是一种成本。</li></ol> <p>因此本文以最常见的 transform 和 opacity 为例（这 2 个可以说一模一样，和渲染逻辑解耦脱钩，下文举例统称为 transform），其它的如果想继续实现可以举一反三。</p> <h1 id="数据结构"><a href="#数据结构" class="header-anchor">#</a> 数据结构</h1> <p>只关注 transform 的话，那么所有渲染相关的数据存取都要关注分离。1 个 Node 节点（可以理解为一个舞台对象）本身是个 JS 对象，还会对应 1 个 WASM 的对象，我们称之为 WASM Node。那么这 2 个属性也自然跟随 WASM Node。</p> <p>1 个 Node 会有任意个动画对象，和这2项相关的是纯 WASM Animation（红色）；不相关的是纯 JS Animation（蓝色）。也时常会出现一个动画中同时有 WASM 和 JS 的混合情况（绿色）。</p> <p><img src="https://p3-sign.toutiaoimg.com/tos-cn-i-qvj2lq49k0/f6f1ffeac0fe4328b9e0b28307ce1c12~noop.image?_iz=58558&amp;from=article.pc_detail&amp;x-expires=1687574112&amp;x-signature=XLOBC8hZA5yq27clXsw4fgwvt%2Bk%3D" alt=""></p> <div class="language- extra-class"><pre class="language-text"><code>// 纯JS动画，x可以理解为css的left
node.animate([
  { x: 0 },
  { x: 100 },
], {
  duration: 1000,
});
// 纯WASM动画，rotateZ即平面旋转
node.animate([
  { rotateZ: 0 },
  { rotateZ: 90 },
], {
  duration: 1000,
});
// 混合动画都有的情况
node.animate([
  { x: 0, rotateZ: 0 },
  { x: 100, rotateZ: 90 },
], {
  duration: 1000,
});
</code></pre></div><p>这在数据结构上对设计提出了挑战，已有的 JS 动画引擎部分最好修改少，且能适配 WASM 动画。</p> <p>笔者采用了所有动画依旧是 JS 为入口，在初始化过后，如果有和 transform 相关的数据（指帧数据），这个 JS 动画对象会新建一个 WASM 动画对象并产生关联，将 transform 的数据传递给 WASM，JS 里删除。</p> <p><img src="https://p3-sign.toutiaoimg.com/tos-cn-i-qvj2lq49k0/cac628c6099e4072a575587e3d8d1f50~noop.image?_iz=58558&amp;from=article.pc_detail&amp;x-expires=1687574112&amp;x-signature=iKQF7CvDf8%2FCrYL1%2BNlM957%2Ft2Y%3D" alt=""></p> <p>红色的 WASM 动画都被包含在蓝色的 JS 的动画中了，如果是个完全的 WASM 动画，那么 JS 很像个纯代理，可以设置个 ignore 标识。</p> <h1 id="流程时钟"><a href="#流程时钟" class="header-anchor">#</a> 流程时钟</h1> <p>先说下 JS 动画引擎的一些流程，它以及它的前置条件或知识。</p> <p>任意的数据更新，都应该是同步的，这点毋庸置疑。</p> <div class="language- extra-class"><pre class="language-text"><code>// 类CSS/WAA伪代码，节点向右平移100px距离
node.style.translateX = 100;

console.log(node.style.translateX); // 输出100
</code></pre></div><p>但渲染却未必是同步的，因为 1 次修改不可能立刻同步重绘，假如有 1000 个节点变化，立刻同步更新 1000 次，怎么优化也不可能达到流畅的效果。</p> <p>所以渲染一定要设计成异步的，同步的代码执行更新后，下一帧再进行绘制。</p> <div class="language- extra-class"><pre class="language-text"><code>// 类CSS/WAA伪代码，很多节点同时更新
for(let i = 0; i &lt; 1000; i++) {
  nodes[i].style.translateX = 100;
}

// 渲染引擎在每个节点更新后会收到一条通知，下帧更新，无论多少节点都是同步通知，但下帧只重绘1次
requestAnimationFrame(() =&gt; {
  draw(); // 只有1次渲染
});
</code></pre></div><p>动画引擎所引发的渲染更新也是如此，但有所不同的是，动画引擎有事件或回调。</p> <p>事件或回调触发时，所有的动画引擎都应该在帧内完成数据更新，甚至是渲染更新好。事件或回调中甚至会触发控制其它动画或新的动画，所以这里的时钟顺序要想好。</p> <p>例：2 个动画对象，这一帧，A 更改 translateX 为 10，B 更改 translateY 为 5。实际编码就是循环遍历已有的这 2 个动画对象，依次执行。</p> <p><img src="https://p3-sign.toutiaoimg.com/tos-cn-i-qvj2lq49k0/ec50e6aef46845d581c641a9f427d547~noop.image?_iz=58558&amp;from=article.pc_detail&amp;x-expires=1687574112&amp;x-signature=ymmUPdRQbbhgJ1XAcBvxWopi%2FqY%3D" alt=""></p> <p>如果有 frame 事件，即动画每帧更新事件，那么不能在 A 更新结束后 B 还未更新就立刻触发，因为此时有歧义：translateY 应该是多少？是否应该是更新后的5？</p> <p>frame 帧事件显然应该是所有数据更新后再触发的。</p> <p><img src="https://p3-sign.toutiaoimg.com/tos-cn-i-qvj2lq49k0/8028271638f4495caf49a6d7969b0b4a~noop.image?_iz=58558&amp;from=article.pc_detail&amp;x-expires=1687574112&amp;x-signature=kyXZaP6E%2BEE89W34ibUdzGp9iIc%3D" alt=""></p> <p>将一帧内的动画分为 2 个前后时序，before 阶段执行所有的动画的数据更新，after 阶段执行所有的动画事件回调。时间复杂度从 O(n)变为O(2n)，可以接受。</p> <p>在 after 阶段，其实很多逻辑都包含在内：判断是否结束、下一轮、结束停留状态等。</p> <p>如果做得更好没有歧义，可以考虑将帧渲染环节放在 before 和 after 之间，这样事件触发时，画面甚至是与数据更新同步对应的。</p> <h1 id="变化"><a href="#变化" class="header-anchor">#</a> 变化</h1> <p>现在 WASM 进场了。</p> <p>前面说了，WASM 适合密集型计算，频繁通信会变得更慢。显然不能让蓝色 JS 动画执行时再去代理调用对应的红色 WASM 动画。假如动画有许多个，可能几十的数量就开始卡顿了。</p> <p>因此，画布根节点 Root 对象必然持有所有 Node 节点的引用和动画对象的引用，且是排好序能高效访问的，无论在 JS 端还是 WASM 端都一样。</p> <p>这样，在执行一帧更新时，before 阶段，Root 先通知 WASM Root 遍历所有的 WASM 动画，再遍历所有的 JS 动画对象（严格来说 WASM 和 JS 遍历前后顺序并不严格要求，甚至所有动画前后都顺序都不严格要求，只是实现可以按照顺序队列）。目前暂时只和 WASM 通信一次。</p> <p>当 WASM 动画或 JS 动画真实产生更新时（有时动画两帧之间并无变化，可节省重绘成本），重绘。</p> <p>再然后，after 阶段，Root 先通知 WASM Root 遍历所有的 WASM 动画，进行状态等数据检查，并保存到一块 SharedBuffer 上（有指针地址），再遍历所有的 JS 动画，将 SharedBuffer 的数据给到JS动画，执行 JS 动画的 after。目前再和 WASM 通信一次。</p> <p>例：有如下 A、B、C、D 共 4 个动画，其中 C、D是 WASM 动画：</p> <p><img src="https://p3-sign.toutiaoimg.com/tos-cn-i-qvj2lq49k0/d66bafedc4584c77aee0e5e185ec3221~noop.image?_iz=58558&amp;from=article.pc_detail&amp;x-expires=1687574112&amp;x-signature=mS6JY8kGHMcmRjp9lGPQ1gKBoeY%3D" alt=""></p> <p>一帧内执行更新的时钟周期：</p> <p><img src="https://p3-sign.toutiaoimg.com/tos-cn-i-qvj2lq49k0/fdb1e0c140a3459fa62e0dbd7d57327d~noop.image?_iz=58558&amp;from=article.pc_detail&amp;x-expires=1687574112&amp;x-signature=hEYjZwTPCTNylt7XFtRXCAJ3uCc%3D" alt=""></p> <p>为什么 after 中要由红色 WASM 的 C 和 D 给到蓝色 JS 的 C 和 D 数据？因为此刻时间的计算都在 WASM 中。</p> <ul><li>当前时间应该是第几帧？</li> <li>是这一帧的哪个位置（百分比）？</li> <li>如果有缓动怎么计算（easing）？</li> <li>播放到第几轮了？</li> <li>是否是反向那一轮（CSS/WAA 的 direction 为 alternative）？</li> <li>是否刚好到最后一帧结束停止了？</li> <li>是还原还是停留（CSS/WAA 的 fill 为 forwards）？</li></ul> <p>这些在 WASM 中计算会非常快，再加上帧数据计算本身。如果 JS 来算的话，一是会重复，二是本身性能优化的意义就失去了。</p> <p>after 中蓝色的 C、D 通过 SharedBuffer 拿到数据后，就可以确定当前动画的一些状态数据，这是非常快的。</p> <div class="language- extra-class"><pre class="language-text"><code>// 伪代码，通过SharedBuffer地址拿WASM的数据
let n = wasmRoot.after(); // n返回有多少个wasm动画
let states = new Uint8Array(wasm.instance.memory.buffer, wasmRoot.states_ptr(), n);
</code></pre></div><h1 id="复杂情况"><a href="#复杂情况" class="header-anchor">#</a> 复杂情况</h1> <p>上述情况还是太简单了，连混合绿色的动画都没有出现过。如果包含绿色混合动画，那么上面提到的那些在 WASM 和 JS 中是会重复计算的（但不包括帧数据计算本身）。这时候要考虑重复的这些性能损耗有多少，和 WASM 带来的提升相比如何。好在据经验来看，出现的频率以及损耗都较小，可以接受。</p> <p>再看另外一个情况，如果 A、B、C、D 的顺序并不规整怎么办？</p> <p><img src="https://p3-sign.toutiaoimg.com/tos-cn-i-qvj2lq49k0/c177609d14d44527a06520338ee59f2b~noop.image?_iz=58558&amp;from=article.pc_detail&amp;x-expires=1687574112&amp;x-signature=nrlCCLXr6lPeYZ73MN089ru3e%2BM%3D" alt=""></p> <p>很容易出现这样的情况，JS 动画和 WASM 动画并不完整连续。</p> <p>在 before 阶段，并没有什么影响，依旧是 WASM 独立执行遍历，然后 JS 再遍历。</p> <p>在 after 阶段，有些不同。先是已知的 WASM，再是 JS，可 SharedBuffer 却要注意了。此刻 SharedBuffer 有 2 项数据，分别是 C 和 D 的。但 JS 拿到时并不知道是 A、B、C、D 哪 2 个的。前面简化例子中，我们假定了它是按顺序后出现的 C、D，这太过理想化。</p> <p>这时候需要加个判断逻辑，先是 JS 代理的动画对象（有 WASM 动画引用）需要有个标识。然后 after 遍历 JS 动画对象时，没有代理的要忽略并计数，有代理的要根据索引 index 和当前计数形成偏移量 offset，来取 SharedBuffer。</p> <div class="language- extra-class"><pre class="language-text"><code>// 伪代码，通过SharedBuffer地址拿WASM的数据
let n = wasmRoot.after(); // n返回有多少个wasm动画
let states = new Uint8Array(wasm.instance.memory.buffer, wasmRoot.states_ptr(), n);
// 偏移计数器
let offset = 0;
// 循环JS动画
for(let i = 0; i &lt; len; i++) {
  let ja = jsAnimations[i];
  // 有代理
  if(ja.wasmAnimation) {
    let state = states[i - offset];
    // 处理传递数据
  }
  else {
    offset++;
  }
  // 执行js的after
  ja.after();
}
</code></pre></div><h1 id="刷新重绘"><a href="#刷新重绘" class="header-anchor">#</a> 刷新重绘</h1> <p>before 步骤执行完成后，after 之前是刷重绘。这里会出现第 3 次 WASM 交互，主要是 matrix 计算。</p> <p>由于节点是个树形结构，有父子关系（兄弟关系对于 matrix 计算几乎无影响，除了 mask 节点这种相邻），对于 matrix 来说要算预乘。</p> <p>较好的遍历方式是扁平化，将树形结构打平，形成 for 循环模式先序遍历，这点不在讨论范围内。</p> <p>3 阶或 4 阶矩阵计算在 WASM 中也比 JS 快，不过性能的提升并没有动画引擎改写那么大。V8 等 JS 引擎对于这种简单热代码优化得要好些。</p> <p>之后亦是通过 SharedBuffer 拿到一个 marix 队列，因为 matrix 是 16 长度的，所以长度注意 *16：</p> <div class="language- extra-class"><pre class="language-text"><code>let matrix = new Float64Array(wasm.instance.memory.buffer, wasmRoot.matrix_ptr(), len * 16);
</code></pre></div><p>查看 performance，也会发现占大头的还是动画中每个对象的执行：</p> <p><img src="https://p3-sign.toutiaoimg.com/tos-cn-i-qvj2lq49k0/e0f74492ebc34e3b92caaa093fa03654~noop.image?_iz=58558&amp;from=article.pc_detail&amp;x-expires=1687574112&amp;x-signature=Gd6CgJtpywIKtQm9%2BnYrx0CoH0k%3D" alt=""></p> <p>（红色动画引擎执行 before，蓝色重绘计算 matrix）</p> <p>如果想进一步优化矩阵乘法，WASM 中可以使用 SIMD 指令，但只在较新浏览器中实现，比如 chrome91：https://chromestatus.com/feature/6533147810332672</p> <p>另外像顶点计算等类似的东西，都可以放进 WASM 中，不仅性能更好，也没有垃圾回收的负担。这些优化初版暂时没有，后续考虑补上。</p> <h1 id="精度"><a href="#精度" class="header-anchor">#</a> 精度</h1> <p>有个计算细节，在 WASM 中所有数字运算都应该先转为 f64 后再进行，因为 JS 中便是如此。如果使用 f32，那么便会出现精度不一致的现象。虽然表面上看起来肉眼无区别，但在一些细致化场景或者对精度要求高的情况，可能会出现意想不到的情况，且非常难以排查。</p> <p>Rust 使用的 wasm-bindgen 在进行地址交换的时候，编译器有个对齐字节的操作。f64 和 f32 会使得对象的指针解引用时有所不同，f32 的 offset 是 4 个字节，f64 是 8 个字节，这种坑不注意也会困扰人许久。</p> <h1 id="benchmark"><a href="#benchmark" class="header-anchor">#</a> benchmark</h1> <p>继续使用之前的一万节点动画性能测试。要求：</p> <ol><li>使用 10000 个包含不同文字、背景色的节点，如果是 CANVAS 模式，降级到 5000 个；</li> <li>所有节点同时进行不同的随机移动、旋转、缩放动画，无限往返；</li> <li>统计 fps 对比，并附上测试 DEMO 源码。</li></ol> <p>http://army8735.me/karasjs/karas/benchmark/karas-wasm-5k.htmlhttp://army8735.me/karasjs/karas/benchmark/karas-canvas-5k.htmlhttp://army8735.me/karasjs/karas/benchmark/pixi-canvas-5k.html</p> <p>http://army8735.me/karasjs/karas/benchmark/karas-webgl-1w.htmlhttp://army8735.me/karasjs/karas/benchmark/karas-wasm-1w.htmlhttp://army8735.me/karasjs/karas/benchmark/pixi-webgl-1w.html</p> <p>https://skottie.skia.org/662e5267a8b58896c5812c24ed61ef90?h=800&amp;w=800</p> <p><img src="https://p3-sign.toutiaoimg.com/tos-cn-i-qvj2lq49k0/d8e079229a6a4f4e9cabf987d183d56f~noop.image?_iz=58558&amp;from=article.pc_detail&amp;x-expires=1687574112&amp;x-signature=fhTlmbnQvniz8YJA8CofYyR2VL8%3D" alt=""></p> <p><img src="https://p3-sign.toutiaoimg.com/tos-cn-i-qvj2lq49k0/2469261a86004be5b601083d6047c5eb~noop.image?_iz=58558&amp;from=article.pc_detail&amp;x-expires=1687574112&amp;x-signature=VEESWb5T8WZeM8M5l3f8f3vRHLU%3D" alt=""></p> <p>神奇的是，pixi 在 pc 和 mobile 上表现差距极大，可能移动端有什么特殊优化。</p> <p>实际上 pixi 的 DEMO 并不是完整的动画引擎，只是个计时器 tick，连层级 1 都不到，完整实现的话性能会大打折扣。</p> <p>skottie 只有 webgl+wasm 模式，且功能受限（只有层级 1）不好比较，约等于 pixi。</p> <h1 id="其他"><a href="#其他" class="header-anchor">#</a> 其他</h1> <p>目前初级版本还有一些细节可以优化，甚至还有新的想法可以尝试。</p> <p>比如大头占比的动画执行，是否也可以考虑使用 SIMD？数量众多的动画对象，亦有些并发的味道，是否可以将那些帧数据中的样式数据（即 transform/matrix/opacity 某个变化）平铺到一些矩阵当中，直接用并行矩阵计算来加速？</p> <p>期待 WASM 的更好的发展。</p> <p>作者:阿侎</p> <p>来源:微信公众号:支付宝体验科技</p> <p>出处
:https://mp.weixin.qq.com/s/pmH559vnTpQ7HLOssyKqiA</p> <p>文章来源：https://www.toutiao.com/article/7203529991232078393/?log_from=d239ee32ad891_1686969311972</p> <!----></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/book/26.html" class="prev">
         使用 scp2 自动布署 vue 编译包到服务器
      </a></span> <span class="next"><a href="/book/364.html">
         你管这破玩意叫指针？
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><section class="side-anchor"><ul style="display:none;"></ul></section></div></div>
    <script src="/book/assets/js/app.c8cf2c2d.js" defer></script><script src="/book/assets/js/3.0d5fb1e8.js" defer></script><script src="/book/assets/js/144.662af319.js" defer></script><script src="/book/assets/js/4.4c5f7830.js" defer></script>
  </body>
</html>
