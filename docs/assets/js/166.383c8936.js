(window.webpackJsonp=window.webpackJsonp||[]).push([[166],{423:function(t,n,e){"use strict";e.r(n);var i=e(10),a=Object(i.a)({},(function(){var t=this.$createElement,n=this._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":this.$parent.slotKey}},[n("h1",{attrs:{id:"移动端图片上传vue组件-包括图片自动转正方向-大小压缩-待理一步优化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#移动端图片上传vue组件-包括图片自动转正方向-大小压缩-待理一步优化"}},[this._v("#")]),this._v(" 移动端图片上传vue组件 （包括图片自动转正方向 大小压缩） 待理一步优化")]),this._v(" "),n("p",[this._v("代码")]),this._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[this._v("<template>\n\t<div class=\"clear\" id=\"uu\">\n\t\t<div class=\"item\" v-for=\"(item,index) in imgs\"\n\t\tv-bind:style=\"{'background': 'url('+item+') center center no-repeat','backgroundSize':'cover','position':'relative','backgroundColor':'#fff'}\"\n\t\t@click=\"showPre(item)\"\n\t\t>\n\n\t\t\t<van-icon name=\"cross\" @click.stop=\"close(index)\"/>\n\n\t\t  \n\t\t</div>\n\t\t<div class=\"item up box box-align-center\" v-if=\"imgs.length<limtNum\">\n\t\t\t<i class=\"fa icon-camera\"></i>\n\n\t\t\t<input :key=\"key\" type=\"file\" @change=\"addImg\" ref=\"inputer\" accept=\"image/png,image/jpeg,image/gif,image/jpg\">\n\t\t</div>\n\n\n\t\t<Preview\n\t\tv-bind:is-show=\"isShow\"\n\t\tv-bind:pro-data=\"img\"\n\t\tv-bind:set-val=\"hide\"\n\t\t>\n\t\n\t\t</Preview>\n\n\t</div>\n</template>\n<script>\n\timport { Field,Toast } from 'vant';\n\timport EXIF from 'exif-js';\n\nVue.use(Field)\n.use(Toast);\n\n\timport Preview from './Preview1.vue';\n\n\texport default{\n\t\tcomponents:{\n\t\t\tPreview\n\t\t},\n\t\tprops:['maxNum','uploadImg'],\n\t\tdata(){\n\t\t\treturn {\n\t\t\t\tkey:'0',\n\n\t\t\t\tisShow:false,\n\t\t\t\timg:'',\n\n\t\t\t\timgs:[\n\t\t\t\t\t// '../../static/img/no.jpg'\n\t\t\t\t],\n\t\t\t\tlimtNum:2,\n\n\t\t\t\tmaxW :2000,\n        \t\tmaxH :2000\n\n\t\t\t}\n\t\t},\n\t\tmethods:{\n\t\t\thide:function(){\n\t\t\t\tthis.isShow = false;\n\t\t\t},\n\n\t\t\tshowPre:function(img){\n\t\t\t\tthis.img = img;\n\t\t\t\tthis.isShow = true;\n\t\t\t},\n\n\t\t\tclose:function(index){\n\t\t\t\tthis.imgs.splice(index,1);\n\n\n\t\t\t\tif(typeof this.uploadImg != 'undefined'){\n\t\t\t\t\t    this.$emit('update:uploadImg',this.imgs.join(','));\n\t\t\t\t\n\t\t\t\t}\n\n\n\t\t\t},\n\t\t\t// 将base64位转换成blob\n\t\t    b64toBlob:function(b64Data, contentType, sliceSize) {\n\t\t            contentType = contentType || '';\n\t\t            sliceSize = sliceSize || 512;\n\n\t\t            var byteCharacters = atob(b64Data);\n\t\t            var byteArrays = [];\n\n\t\t            for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {\n\t\t                var slice = byteCharacters.slice(offset, offset + sliceSize);\n\n\t\t                var byteNumbers = new Array(slice.length);\n\t\t                for (var i = 0; i < slice.length; i++) {\n\t\t                    byteNumbers[i] = slice.charCodeAt(i);\n\t\t                }\n\n\t\t                var byteArray = new Uint8Array(byteNumbers);\n\n\t\t                byteArrays.push(byteArray);\n\t\t            }\n\n\t\t            var blob = new Blob(byteArrays, {type: contentType});\n\t\t            return blob;\n\t\t        },\n\t\t    dataURLtoBlob:function(baseurl) {\n\t\t\t    let arr = baseurl.split(','),\n\t\t\t        mime = arr[0].match(/:(.*?);/)[1],\n\t\t\t        bstr = atob(arr[1]),\n\t\t\t        n = bstr.length,\n\t\t\t        u8arr = new Uint8Array(n);\n\t\t\t    while (n--) {\n\t\t\t        u8arr[n] = bstr.charCodeAt(n);\n\t\t\t    }\n\t\t\t    return new Blob([u8arr], {\n\t\t\t        type: mime\n\t\t\t    });\n\t\t\t},\n\t\t\ttoBlob:function(obj){\n\n\t\t\t\tToast.clear();\n\n\t\t\t\tvar canvas = document.createElement('canvas');\n\t\t\t\tvar ctx = canvas.getContext(\"2d\");\n\t\t\t\tcanvas.width = obj.w;\n\t\t\t\tcanvas.height = obj.h;\n\n\n\t\t\t\tctx.drawImage(\n\t\t\t\t\tobj.c, \n\t\t\t\t\tobj.l, obj.t,\n\t\t\t\t\tobj.w,\n\t\t\t\t\tobj.h,\n\t\t\t\t\t0,0,\n\t\t\t\t\tobj.w,\n\t\t\t\t\tobj.h\n\t\t\t\t\t);\n\n\n\n\t\t\t\t// document.getElementById('uu').appendChild(canvas);\n\n\t\t\t\tobj.c = null;\n\n\t\t\t\t// console.log(canvas.toDataURL(\"image/png\"));\n\n\t\t\t\t// console.log(this.b64toBlob(canvas.toDataURL(\"image/png\").replace('data:image/png;base64,','')));\n\t\t\t\t// \n\t\t\n\t\t\t\tToast.loading({\n\t\t\t\t  message: '上传中...',\n\t\t\t\t  forbidClick: true,\n\t\t\t\t  loadingType: 'spinner',\n\t\t\t\t  overlay:true,\n\t\t\t\t  duration:0\n\t\t\t\t});\n\n\n\t\t\t\tthis.$postWithFile('/system/uploadFile',{\n\t\t\t\t// this.$post('/system/uploadAppFile',{\n\n\t\t\t\t\tfile:this.b64toBlob(canvas.toDataURL(\"image/png\").replace('data:image/png;base64,',''),\"image/png\"), \n\t\t\t\t\t// file:canvas.toDataURL(\"image/png\").replace('data:image/png;base64,','')\n\t\t\t\t}).then(({code,obj})=>{\n\n\t\t\t\t\tToast.clear();\n\n\t\t\t\t\tcanvas = null;\n\n\n\t\t\t\t\t(code == '00') &&\n\t\t\t\t\tthis.imgs.push(obj);\n\n\t\t\t\t\tif(typeof this.uploadImg != 'undefined'){\n\t\t\t\t\t    this.$emit('update:uploadImg',this.imgs.join(','));\n\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.key++;\n\n\n\t\t\t\t\t// this.uploadImg && (this.uploadImg = this.imgs.join(','))\n\n\n\t\t\t\t})\n\n\n\t\t\t},\n\t\t\tcreateCanvas:function(infoObj){\n\t\t\t\tlet cW;\n\t\t\t\tlet offL;\n\t\t\t\tlet offT;\n\n\t\t\t\t//以最长边生成canvas 把图片绘到中间\n\t\t\t\tif(infoObj.w>=infoObj.h){\n\n\t\t\t\t\tcW = infoObj.w;\n\n\t\t\t\t\toffT = (cW-infoObj.h)*0.5;\n\t\t\t\t\toffL = 0;\n\n\n\n\n\t\t\t\t}else{\n\t\t\t\t\tcW = infoObj.h;\n\t\t\t\t\toffT = 0;\n\t\t\t\t\toffL = (cW-infoObj.w)*0.5;\n\t\t\t\t}\n\n\t\t\t\tvar degree = 0;\n\n\t\t\t\t//旋转后图片在画布上坐标 大小\n\t\t\t\t// var nOffL = (this.maxW - infoObj.w)*0.5;\n\t\t\t\t// var nOffT = (this.maxH - infoObj.h)*0.5;\n\t\t\t\tvar nOffL = (cW - infoObj.w)*0.5;\n\t\t\t\tvar nOffT = (cW - infoObj.h)*0.5;\n\n\n\t\t\t\tvar nW = infoObj.w;\n\t\t\t\tvar nH = infoObj.h;\n\n\n\n\t\t\t\tif(typeof infoObj.o != 'undefined'){\n\n\t\t\t\t\tswitch(infoObj.o){\n\t\t\t\t\t\tcase 6:\n\t\t\t\t\t\t\tdegree = 90;\n\n\t\t\t\t\t\t\t// nOffL = (this.maxW - infoObj.h)*0.5;\n\t\t\t\t\t\t\t// nOffT = (this.maxH - infoObj.w)*0.5;\n\t\t\t\t\t\t\tnOffL = (cW - infoObj.h)*0.5;\n\t\t\t\t\t\t\tnOffT = (cW - infoObj.w)*0.5;\n\n\n\t\t\t\t\t\t\tnW = infoObj.h;\n\t\t\t\t\t\t\tnH = infoObj.w;\n\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 8:\n\t\t\t\t\t\t\tdegree = -90;\n\n\t\t\t\t\t\t\t// nOffL = (this.maxW - infoObj.h)*0.5;\n\t\t\t\t\t\t\t// nOffT = (this.maxH - infoObj.w)*0.5;\n\t\t\t\t\t\t\tnOffL = (cW - infoObj.h)*0.5;\n\t\t\t\t\t\t\tnOffT = (cW - infoObj.w)*0.5;\n\t\t\t\t\t\t\tnW = infoObj.h;\n\t\t\t\t\t\t\tnH = infoObj.w;\n\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 3:\n\t\t\t\t\t\t\tdegree = 180;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t}\n\t\t\t\t}\n\n\n\n\n\t\t\t\tvar canvas = document.createElement('canvas');\n\t\t\t\tvar ctx = canvas.getContext(\"2d\");\n\t\t\t\tcanvas.width = cW;\n\t\t\t\tcanvas.height = cW;\n\n\t\t\t\tconsole.log('偏移');\n\t\t\t\tconsole.log(offL,offT);\n\n\t\t\t\tctx.translate(cW*0.5, cW*0.5);\n\t\t\t\tctx.rotate(degree*Math.PI/180); \n\t\t\t\tctx.translate(-cW*0.5, -cW*0.5);\n\n\n\t\t\t\tctx.drawImage(\n\t\t\t\t\tinfoObj.file, \n\t\t\t\t\t0, 0,\n\t\t\t\t\tinfoObj.file.width,\n\t\t\t\t\tinfoObj.file.height,\n\t\t\t\t\toffL,offT,\n\t\t\t\t\tinfoObj.w,\n\t\t\t\t\tinfoObj.h\n\t\t\t\t\t);\n\n\n\t\n\t\t\t\t// document.getElementById('uu').appendChild(canvas);\n\n\t\t\t\t//方向旋转后 重绘一次 去掉空白\n\t\t\t\tconsole.log('旋转后的图片坐标');\n\t\t\t\tconsole.log(nOffL,nOffT);\n\n\t\t\t\tthis.toBlob({\n\t\t\t\t\tl:nOffL,\n\t\t\t\t\tt:nOffT,\n\t\t\t\t\tw:nW,\n\t\t\t\t\th:nH,\n\t\t\t\t\tc:canvas\n\t\t\t\t})\n\n\n\n\n\t\t\t},\n\t\t\tzoom:function(file,Orientation){\n\n\t\t\t\tToast.loading({\n\t\t\t\t  message: '压缩中...',\n\t\t\t\t  forbidClick: true,\n\t\t\t\t  loadingType: 'spinner',\n\t\t\t\t  overlay:true,\n\t\t\t\t  duration:0\n\t\t\t\t});\n\n\n\t\t\t\tvar _this = this;\n\t\t\t\tlet oReader = new FileReader();\n\t\t        oReader.onload = function(e) {\n\t\t        \tconsole.log(e);\n\n\t\t        \tlet img = new Image();\n\t\t        \timg.onload = function(){\n\t\t        \t\tlet width = this.naturalWidth;\n\t\t        \t\tlet height = this.naturalHeight;\n\n\t\t        \t\tconsole.log(width,height); \n \n\t\t        \t\t// if((width >=_this.maxW) || (height>=_this.maxH)){  //超过200开始缩放\n\t\t        \t\t\tif(width >_this.maxW){  //等比缩小\n\n\t\t        \t\t\t\tvar rate = width / _this.maxW;\n\t\t        \t\t\t\tvar nWidth = _this.maxW;\n\t\t        \t\t\t\tvar nHeight = height/rate; \n\n\t\t        \t\t\t}else{  //保持图片原尺寸\n\n\t\t        \t\t\t\tvar rate = height / _this.maxH;\n\t\t        \t\t\t\tvar nWidth = width/rate;\n\t\t        \t\t\t\tvar nHeight = _this.maxH;\n\n\t\t        \t\t\t\tvar nWidth = width;\n\t\t        \t\t\t\tvar nHeight = height;\n\n\n\t\t  \n\t\t        \t\t\t}\n\n\t\t        \t\t\tconsole.log('计算后的大小：')\n\t\t\t\t\t\t\tconsole.log(nWidth,nHeight);\n\n\t\t\t\t\t\t\t// return false;\n\n\n\t\t\t\t\t\t\t_this.createCanvas({\n\t\t\t\t\t\t\t\tw:nWidth,\n\t\t\t\t\t\t\t\th:nHeight,\n\t\t\t\t\t\t\t\to:Orientation,\n\t\t\t\t\t\t\t\tfile:img\n\t\t\t\t\t\t\t})\n\n\t\t        \t\t// }else{\n\n\t\t        \t\t// \tconsole.log('不需要压缩');\n\n\n\n\n\t\t        \t\t// }\n\n\n\n\t\t        \t}\n\t\t        \timg.src = e.target.result;\n\n\n\t\t        }\n\t\t        oReader.readAsDataURL(file);\n\t\t\t},\n\t\t\tgetOrientation:function(file){\n\n\t\t\t\t\tToast.clear();\n\n\t\t\t\tlet _this = this;\n\t\t\t\tEXIF.getData(file, function() {\n\t\t           // alert(EXIF.pretty(this));\n\t\t            EXIF.getAllTags(this); \n\t\t            //alert(EXIF.getTag(this, 'Orientation')); \n\t\t            let Orientation = EXIF.getTag(this, 'Orientation');\n\t\t            console.log(Orientation);\n\n\t\t            _this.zoom(file,Orientation);\n\n\t\t        });\n\t\t\t},\n\t\t\taddImg:function(){\n\n\t\t\t\tif(this.limtNum == this.imgs.length){\n\n\t\t\t\t\tToast('最多可上传'+this.limtNum+'张图片！');\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\n\n\t\t\t\tlet inputDOM = this.$refs.inputer; \n\n\t\t\t\tToast.loading({\n\t\t\t\t  message: '上传中...',\n\t\t\t\t  forbidClick: true,\n\t\t\t\t  loadingType: 'spinner',\n\t\t\t\t  overlay:true,\n\t\t\t\t  duration:0\n\t\t\t\t});\n\n\t\t\t\tthis.getOrientation(inputDOM.files[0]);\n\n\n\t\t       \treturn false;\n\n\n\t\t\t\t// Toast.loading({\n\t\t\t\t//   message: '上传中...',\n\t\t\t\t//   forbidClick: true,\n\t\t\t\t//   loadingType: 'spinner',\n\t\t\t\t//   overlay:true,\n\t\t\t\t//   duration:0\n\t\t\t\t// });\n\n\n\t\t\t\t// this.$postWithFile('/system/uploadFile',{\n\t\t\t\t// \tfile:inputDOM.files[0], \n\t\t\t\t// }).then(({code,obj})=>{\n\n\t\t\t\t// \tToast.clear();\n\n\n\t\t\t\t// \t(code == '00') &&\n\t\t\t\t// \tthis.imgs.push(obj);\n\n\t\t\t\t// \tif(typeof this.uploadImg != 'undefined'){\n\t\t\t\t// \t    this.$emit('update:uploadImg',this.imgs.join(','));\n\n\t\t\t\t// \t}\n\n\n\n\t\t\t\t// \t// this.uploadImg && (this.uploadImg = this.imgs.join(','))\n\n\n\t\t\t\t// })\n\n\n\n\t\t\t}\n\n\t\t},\n\t\tmounted(){\n\n\t\t\tif(typeof this.maxNum !='undefined'){\n\t\t\t\tthis.limtNum = this.maxNum;\n\t\t\t} \n\t\n\n\t\t},\n\t\tcreated(){\n\t\n\t\t}\n\t}\n\n<\/script>\n<style scoped>\n\n\t.item{\n\t\tposition: relative;\n\t\tfloat: left;\n\t\twidth: 50%;\n\t\t-webkit-transform-origin: left top;\n\t\t-moz-transform-origin: left top;\n\t\t-ms-transform-origin: left top;\n\t\t-o-transform-origin: left top;\n\t\ttransform-origin: left top;\n\t\t-webkit-transform: scale(0.9);\n\t\t-ms-transform: scale(0.9);\n\t\t-o-transform: scale(0.9);\n\t\ttransform: scale(0.9);\n\t}\n\t.item:after{\n\t\tcontent: \"\";\n\t\tdisplay: block;\n\n\t\tmargin-top:100%;\n\n\t}\n\t.up{\n\t\tbox-sizing:border-box;\n\t\tborder:dashed #c3c3c3 1px; \n\t}\n\t.up input{\n\t\tposition: absolute;\n\t\tleft:0;\n\t\ttop:0;\n\t\tbottom:0;\n\t\twidth: 100%;\n\t\theight:100%;\n\t\topacity: 0;\n\t}\n\t.item .van-icon-cross{\n\t\tposition: absolute;\n\t\ttop:0;\n\t\tright:0;\n\t\tfont-size: 20px;\n\t\tbackground: #FC9153;\n\t\tcolor: #fff;\n\t\tborder-radius: 15px;\n\t\tpadding:5px;\n\n\t}\n\t.icon-camera{\n\t\tfont-size: 50px;\n\t\tcolor: #999\n\t}\n\n</style>\n")])])]),n("backTop")],1)}),[],!1,null,null,null);n.default=a.exports}}]);