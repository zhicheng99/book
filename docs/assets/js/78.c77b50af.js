(window.webpackJsonp=window.webpackJsonp||[]).push([[78],{356:function(t,s,a){"use strict";a.r(s);var e=a(10),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"emoji等表情符号存mysql的方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#emoji等表情符号存mysql的方法"}},[t._v("#")]),t._v(" [emoji等表情符号存mysql的方法]")]),t._v(" "),a("p",[t._v("项目中需要存储用户信息（用户昵称有表情符号），自然就遇到了emoji等表情符号如何被mysql DB支持的问题")]),t._v(" "),a("p",[t._v("这里引用先行者博文：https://segmentfault.com/a/1190000000616820")]),t._v(" "),a("p",[t._v("如果UTF8字符集且是Java服务器的话，当存储含有emoji表情时，会抛出类似如下异常：")]),t._v(" "),a("pre",{staticClass:"hljs groovy"},[t._v("java.sql."),a("span",{staticClass:"hljs-string"},[t._v("SQLException: Incorrect string "),a("span",{staticClass:"hljs-string"},[t._v("value: "),a("span",{staticClass:"hljs-string"},[t._v("'xF0x9Fx92x94' "),a("span",{staticClass:"hljs-keyword"},[t._v("for column "),a("span",{staticClass:"hljs-string"},[t._v("'name' at row "),a("span",{staticClass:"hljs-number"},[t._v("1  \n    at com.mysql.jdbc.SQLError.createSQLException(SQLError."),a("span",{staticClass:"hljs-string"},[t._v("java:"),a("span",{staticClass:"hljs-number"},[t._v("1073)  \n    at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO."),a("span",{staticClass:"hljs-string"},[t._v("java:"),a("span",{staticClass:"hljs-number"},[t._v("3593)  \n    at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO."),a("span",{staticClass:"hljs-string"},[t._v("java:"),a("span",{staticClass:"hljs-number"},[t._v("3525)  \n    at com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO."),a("span",{staticClass:"hljs-string"},[t._v("java:"),a("span",{staticClass:"hljs-number"},[t._v("1986)  \n    at com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO."),a("span",{staticClass:"hljs-string"},[t._v("java:"),a("span",{staticClass:"hljs-number"},[t._v("2140)  \n    at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl."),a("span",{staticClass:"hljs-string"},[t._v("java:"),a("span",{staticClass:"hljs-number"},[t._v("2620)  \n    at com.mysql.jdbc.StatementImpl.executeUpdate(StatementImpl."),a("span",{staticClass:"hljs-string"},[t._v("java:"),a("span",{staticClass:"hljs-number"},[t._v("1662)  \n    at com.mysql.jdbc.StatementImpl.executeUpdate(StatementImpl."),a("span",{staticClass:"hljs-string"},[t._v("java:"),a("span",{staticClass:"hljs-number"},[t._v("1581)")])])])])])])])])])])])])])])])])])])])])])])]),t._v(" "),a("p",[t._v("这就是字符集不支持的异常。因为UTF-8编码有可能是两个、三个、四个字节，其中Emoji表情是4个字节，而Mysql的utf8编码最多3个字节，所以导致了数据插不进去。")]),t._v(" "),a("h2",{attrs:{id:"升级前需要考虑的问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#升级前需要考虑的问题"}},[t._v("#")]),t._v(" 升级前需要考虑的问题：")]),t._v(" "),a("p",[t._v("如果你的项目要进行移动产品的用户文本的存储，将你的DB字符集从UTF8/GBK等传统字符集升级到utf8mb4将是势在必行。你可以通过应用层面转换emoji等特殊字符，以达到原DB的兼容，我认为可行，但是你可能走了弯路。")]),t._v(" "),a("p",[t._v("utf8mb4作为utf8的super set，完全向下兼容，所以不用担心字符的兼容性问题。切换中需要顾虑的主要影响是mysql需要重新启动（虽然mysql官方文档说可以动态修改配置，但是经过数次测试，还是需要重启才可生效），对于业务可用率的影响是需要考虑的大问题，这里就暂时不展开讨论了。")]),t._v(" "),a("h2",{attrs:{id:"升级步骤"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#升级步骤"}},[t._v("#")]),t._v(" 升级步骤：")]),t._v(" "),a("p",[a("strong",[t._v("1.utf8mb4的最低mysql版本支持版本为5.5.3+，若不是，请升级到较新版本。")])]),t._v(" "),a("p",[t._v("mysql版本查看命令请看：查看mysql版本的四种方法；mysql安装步骤请看：Linux中升级Mysql到Mysql最新版本的方法\n**2.修改database、table和column字符集。**参考以下语句：\nALTER DATABASE database_name CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;\nALTER TABLE table_name CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;\nALTER TABLE table_name CHANGE column_name VARCHAR(191) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;\n"),a("strong",[t._v("3.修改mysql配置文件my.cnf（windows为my.ini）")])]),t._v(" "),a("p",[t._v("my.cnf一般在etc/mysql/my.cnf位置。找到后请在以下三部分里添加如下内容：")]),t._v(" "),a("p",[t._v("[client]\ndefault-character-set = utf8mb4")]),t._v(" "),a("p",[t._v("[mysql]\ndefault-character-set = utf8mb4")]),t._v(" "),a("p",[t._v("[mysqld]\ncharacter-set-client-handshake = FALSE\ncharacter-set-server = utf8mb4\ncollation-server = utf8mb4_unicode_ci\ninit_connect='SET NAMES utf8mb4'")]),t._v(" "),a("p",[a("strong",[t._v("4.重启 MySQL Server、检查字符集")])]),t._v(" "),a("p",[t._v("1.）重启命令参考：/etc/init.d/mysql restart")]),t._v(" "),a("p",[t._v("2.）输入命令：mysql，进入mysql命令行（如果提示没权限，可以尝试输入mysql -uroot -p你的密码）")]),t._v(" "),a("p",[t._v("3.）在mysql命令行中输入：SHOW VARIABLES WHERE Variable_name LIKE 'character_set_%' OR Variable_name LIKE 'collation%';")]),t._v(" "),a("p",[t._v("检查是否如下：")]),t._v(" "),a("p",[t._v("+--------------------------+--------------------+\n| Variable_name            | Value              |\n+--------------------------+--------------------+\n| character_set_client    | utf8mb4            |\n| character_set_connection | utf8mb4            |\n| character_set_database  | utf8mb4            |\n| character_set_filesystem | binary            |\n| character_set_results    | utf8mb4            |\n| character_set_server    | utf8mb4            |\n| character_set_system    | utf8              |\n| collation_connection    | utf8mb4_unicode_ci |\n| collation_database      | utf8mb4_unicode_ci |\n| collation_server        | utf8mb4_unicode_ci |\n+--------------------------+--------------------+\nrows in set (0.00 sec)")]),t._v(" "),a("p",[t._v("特别说明下：collation_connection/collation_database/collation_server如果是utf8mb4_general_ci，没有关系。但必须保证character_set_client/character_set_connection/character_set_database/character_set_results/character_set_server为utf8mb4。关于这些字符集配置是干什么用的，有什么区别，请参考：深入Mysql字符集设置")]),t._v(" "),a("p",[a("strong",[t._v("5.如果你用的是java服务器，升级或确保你的mysql connector版本高于5.1.13，否则仍然无法使用utf8mb4")]),t._v("\n这是mysql官方release note，大家可以查看说明，并下载最新的mysql connector for java的jar包。\n这里为大家提供一个：mysql-connector-java-5.1.31-bin.jar\n同时记得修改pom配置哦~")]),t._v(" "),a("p",[a("strong",[t._v("6.检查你服务端的db配置文件：")])]),t._v(" "),a("p",[t._v("jdbc.driverClassName=com.mysql.jdbc.Driver\njdbc.url=jdbc:mysql://localhost:3306/database?useUnicode=true&characterEncoding=utf8&autoReconnect=true&rewriteBatchedStatements=TRUE\njdbc.username=root\njdbc.password=password")]),t._v(" "),a("p",[t._v("特别说明其中的jdbc.url配置：如果你已经升级好了mysql-connector，其中的characterEncoding=utf8可以被自动被识别为utf8mb4（当然也兼容原来的utf8），而autoReconnect配置我强烈建议配上，我之前就是忽略了这个属性，导致因为缓存缘故，没有读取到DB最新配置，导致一直无法使用utf8mb4字符集，多么痛的领悟！！")]),t._v(" "),a("p",[t._v("源地址：https://segmentfault.com/a/1190000000616820")]),t._v(" "),a("p",[t._v("文章来源：https://www.cnblogs.com/ccit/p/10064819.html")]),t._v(" "),a("p",[t._v("补充：除了数据库相关的字符集需要修改外  程序中连接数据库的部分也得指定字符集（第6点）  否则还会报错")]),t._v(" "),a("backTop")],1)}),[],!1,null,null,null);s.default=n.exports}}]);