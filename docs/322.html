<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前端搞工程化：从零打造性能检测库「源码 + 视频」 | 日常收集</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/book/assets/css/0.styles.d473fa6d.css" as="style"><link rel="preload" href="/book/assets/js/app.a5076a9c.js" as="script"><link rel="preload" href="/book/assets/js/3.0d5fb1e8.js" as="script"><link rel="preload" href="/book/assets/js/115.35834155.js" as="script"><link rel="preload" href="/book/assets/js/4.4c5f7830.js" as="script"><link rel="prefetch" href="/book/assets/js/10.c9f436af.js"><link rel="prefetch" href="/book/assets/js/100.c1fda999.js"><link rel="prefetch" href="/book/assets/js/101.26415c0a.js"><link rel="prefetch" href="/book/assets/js/102.04b9bf96.js"><link rel="prefetch" href="/book/assets/js/103.e1bb0d05.js"><link rel="prefetch" href="/book/assets/js/104.cc97244d.js"><link rel="prefetch" href="/book/assets/js/105.797b59ae.js"><link rel="prefetch" href="/book/assets/js/106.fac66328.js"><link rel="prefetch" href="/book/assets/js/107.a7c0255b.js"><link rel="prefetch" href="/book/assets/js/108.3aae0552.js"><link rel="prefetch" href="/book/assets/js/109.5dba325c.js"><link rel="prefetch" href="/book/assets/js/11.5e1abf35.js"><link rel="prefetch" href="/book/assets/js/110.a40e4289.js"><link rel="prefetch" href="/book/assets/js/111.79be6c5c.js"><link rel="prefetch" href="/book/assets/js/112.39a68b1f.js"><link rel="prefetch" href="/book/assets/js/113.d14d5801.js"><link rel="prefetch" href="/book/assets/js/114.9e3a5ae5.js"><link rel="prefetch" href="/book/assets/js/116.d728568b.js"><link rel="prefetch" href="/book/assets/js/117.57e7cda5.js"><link rel="prefetch" href="/book/assets/js/118.4cca96d1.js"><link rel="prefetch" href="/book/assets/js/119.e5e0d751.js"><link rel="prefetch" href="/book/assets/js/12.571f12ac.js"><link rel="prefetch" href="/book/assets/js/120.4bd8280b.js"><link rel="prefetch" href="/book/assets/js/121.96434c11.js"><link rel="prefetch" href="/book/assets/js/122.60e9d0a0.js"><link rel="prefetch" href="/book/assets/js/123.d8ddea9c.js"><link rel="prefetch" href="/book/assets/js/124.839d24ad.js"><link rel="prefetch" href="/book/assets/js/125.1e732e3b.js"><link rel="prefetch" href="/book/assets/js/126.5d06ad3c.js"><link rel="prefetch" href="/book/assets/js/127.fa6f9e4f.js"><link rel="prefetch" href="/book/assets/js/128.731e9566.js"><link rel="prefetch" href="/book/assets/js/129.ade4c04a.js"><link rel="prefetch" href="/book/assets/js/13.94f0d951.js"><link rel="prefetch" href="/book/assets/js/130.e76b6393.js"><link rel="prefetch" href="/book/assets/js/131.cf345960.js"><link rel="prefetch" href="/book/assets/js/132.250f9d42.js"><link rel="prefetch" href="/book/assets/js/133.1a253cb2.js"><link rel="prefetch" href="/book/assets/js/134.fd4dd490.js"><link rel="prefetch" href="/book/assets/js/135.aad97280.js"><link rel="prefetch" href="/book/assets/js/136.17c9c79f.js"><link rel="prefetch" href="/book/assets/js/137.a64814a1.js"><link rel="prefetch" href="/book/assets/js/138.2f3a4047.js"><link rel="prefetch" href="/book/assets/js/139.99e6a29a.js"><link rel="prefetch" href="/book/assets/js/14.3d533f57.js"><link rel="prefetch" href="/book/assets/js/140.4d15508e.js"><link rel="prefetch" href="/book/assets/js/141.dc9a0fd9.js"><link rel="prefetch" href="/book/assets/js/142.68b18508.js"><link rel="prefetch" href="/book/assets/js/143.9a606518.js"><link rel="prefetch" href="/book/assets/js/144.f3ddc97d.js"><link rel="prefetch" href="/book/assets/js/145.03e0c0cb.js"><link rel="prefetch" href="/book/assets/js/146.011737f0.js"><link rel="prefetch" href="/book/assets/js/147.971b8acb.js"><link rel="prefetch" href="/book/assets/js/148.8bed0c77.js"><link rel="prefetch" href="/book/assets/js/149.da62226e.js"><link rel="prefetch" href="/book/assets/js/15.64e47055.js"><link rel="prefetch" href="/book/assets/js/150.8ab4f803.js"><link rel="prefetch" href="/book/assets/js/151.7c25e3a9.js"><link rel="prefetch" href="/book/assets/js/152.ef17e0ab.js"><link rel="prefetch" href="/book/assets/js/153.66076b2e.js"><link rel="prefetch" href="/book/assets/js/154.c5fb3b0f.js"><link rel="prefetch" href="/book/assets/js/155.d91cc7fa.js"><link rel="prefetch" href="/book/assets/js/156.2a84a2b9.js"><link rel="prefetch" href="/book/assets/js/157.f4d214f5.js"><link rel="prefetch" href="/book/assets/js/158.be218fd3.js"><link rel="prefetch" href="/book/assets/js/159.433d8420.js"><link rel="prefetch" href="/book/assets/js/16.9f90f744.js"><link rel="prefetch" href="/book/assets/js/160.943cc1a3.js"><link rel="prefetch" href="/book/assets/js/161.f6e3ee5a.js"><link rel="prefetch" href="/book/assets/js/162.bf279bcd.js"><link rel="prefetch" href="/book/assets/js/17.b8b34eba.js"><link rel="prefetch" href="/book/assets/js/18.af91aa32.js"><link rel="prefetch" href="/book/assets/js/19.323db867.js"><link rel="prefetch" href="/book/assets/js/20.cfa0aec5.js"><link rel="prefetch" href="/book/assets/js/21.6229732b.js"><link rel="prefetch" href="/book/assets/js/22.0075949b.js"><link rel="prefetch" href="/book/assets/js/23.fb025ad5.js"><link rel="prefetch" href="/book/assets/js/24.36f14df7.js"><link rel="prefetch" href="/book/assets/js/25.e0f6451f.js"><link rel="prefetch" href="/book/assets/js/26.dc431926.js"><link rel="prefetch" href="/book/assets/js/27.237a8e5f.js"><link rel="prefetch" href="/book/assets/js/28.4ef0a215.js"><link rel="prefetch" href="/book/assets/js/29.b434dc9b.js"><link rel="prefetch" href="/book/assets/js/30.72ff699c.js"><link rel="prefetch" href="/book/assets/js/31.a79e209c.js"><link rel="prefetch" href="/book/assets/js/32.0869bd1c.js"><link rel="prefetch" href="/book/assets/js/33.db31ca56.js"><link rel="prefetch" href="/book/assets/js/34.75da57c9.js"><link rel="prefetch" href="/book/assets/js/35.10ae92e8.js"><link rel="prefetch" href="/book/assets/js/36.73b85eab.js"><link rel="prefetch" href="/book/assets/js/37.cd9b41b0.js"><link rel="prefetch" href="/book/assets/js/38.43de425f.js"><link rel="prefetch" href="/book/assets/js/39.1dd2fbe4.js"><link rel="prefetch" href="/book/assets/js/40.1b68ef64.js"><link rel="prefetch" href="/book/assets/js/41.9e49e0cf.js"><link rel="prefetch" href="/book/assets/js/42.03fbcb0f.js"><link rel="prefetch" href="/book/assets/js/43.fe97e66d.js"><link rel="prefetch" href="/book/assets/js/44.90269fc6.js"><link rel="prefetch" href="/book/assets/js/45.7cb71ba0.js"><link rel="prefetch" href="/book/assets/js/46.ee091a2d.js"><link rel="prefetch" href="/book/assets/js/47.c58a3824.js"><link rel="prefetch" href="/book/assets/js/48.6a7c34b1.js"><link rel="prefetch" href="/book/assets/js/49.493683e6.js"><link rel="prefetch" href="/book/assets/js/5.c91de22c.js"><link rel="prefetch" href="/book/assets/js/50.532c274a.js"><link rel="prefetch" href="/book/assets/js/51.e333bb78.js"><link rel="prefetch" href="/book/assets/js/52.853c6004.js"><link rel="prefetch" href="/book/assets/js/53.e42cc193.js"><link rel="prefetch" href="/book/assets/js/54.4524c464.js"><link rel="prefetch" href="/book/assets/js/55.e4236b84.js"><link rel="prefetch" href="/book/assets/js/56.a9485332.js"><link rel="prefetch" href="/book/assets/js/57.1debe95a.js"><link rel="prefetch" href="/book/assets/js/58.9461e577.js"><link rel="prefetch" href="/book/assets/js/59.b88afba7.js"><link rel="prefetch" href="/book/assets/js/6.961a656a.js"><link rel="prefetch" href="/book/assets/js/60.87528566.js"><link rel="prefetch" href="/book/assets/js/61.0907f36e.js"><link rel="prefetch" href="/book/assets/js/62.f75b6320.js"><link rel="prefetch" href="/book/assets/js/63.11581819.js"><link rel="prefetch" href="/book/assets/js/64.6e01c8f8.js"><link rel="prefetch" href="/book/assets/js/65.86da1028.js"><link rel="prefetch" href="/book/assets/js/66.76b41ac7.js"><link rel="prefetch" href="/book/assets/js/67.73445576.js"><link rel="prefetch" href="/book/assets/js/68.5d563c69.js"><link rel="prefetch" href="/book/assets/js/69.cbcad7b9.js"><link rel="prefetch" href="/book/assets/js/7.e5eadd5e.js"><link rel="prefetch" href="/book/assets/js/70.2f2db2a2.js"><link rel="prefetch" href="/book/assets/js/71.0398ac26.js"><link rel="prefetch" href="/book/assets/js/72.2e571244.js"><link rel="prefetch" href="/book/assets/js/73.8fdece9d.js"><link rel="prefetch" href="/book/assets/js/74.22068dc5.js"><link rel="prefetch" href="/book/assets/js/75.468772e2.js"><link rel="prefetch" href="/book/assets/js/76.417b00cf.js"><link rel="prefetch" href="/book/assets/js/77.569c3ef1.js"><link rel="prefetch" href="/book/assets/js/78.8a649646.js"><link rel="prefetch" href="/book/assets/js/79.11b76a35.js"><link rel="prefetch" href="/book/assets/js/8.3201113b.js"><link rel="prefetch" href="/book/assets/js/80.7784e3a4.js"><link rel="prefetch" href="/book/assets/js/81.7a092123.js"><link rel="prefetch" href="/book/assets/js/82.5811a617.js"><link rel="prefetch" href="/book/assets/js/83.83712b60.js"><link rel="prefetch" href="/book/assets/js/84.81792bea.js"><link rel="prefetch" href="/book/assets/js/85.77fe68d2.js"><link rel="prefetch" href="/book/assets/js/86.c0554384.js"><link rel="prefetch" href="/book/assets/js/87.c7a91fbd.js"><link rel="prefetch" href="/book/assets/js/88.6cbb9486.js"><link rel="prefetch" href="/book/assets/js/89.d8cafb07.js"><link rel="prefetch" href="/book/assets/js/9.5cf4899a.js"><link rel="prefetch" href="/book/assets/js/90.ad729539.js"><link rel="prefetch" href="/book/assets/js/91.7e279ed0.js"><link rel="prefetch" href="/book/assets/js/92.91b4bfa4.js"><link rel="prefetch" href="/book/assets/js/93.9aad052b.js"><link rel="prefetch" href="/book/assets/js/94.b3947813.js"><link rel="prefetch" href="/book/assets/js/95.175853bf.js"><link rel="prefetch" href="/book/assets/js/96.a67ba26d.js"><link rel="prefetch" href="/book/assets/js/97.d1ef626d.js"><link rel="prefetch" href="/book/assets/js/98.68aa75ea.js"><link rel="prefetch" href="/book/assets/js/99.fcdaeecb.js"><link rel="prefetch" href="/book/assets/js/vendors~docsearch.c8693219.js">
    <link rel="stylesheet" href="/book/assets/css/0.styles.d473fa6d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/book/" class="home-link router-link-active"><!----> <span class="site-name">日常收集</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>dom的事件</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/book/291.html" class="sidebar-link">Javascript事件捕获与事件冒泡</a></li><li><a href="/book/194.html" class="sidebar-link">DOM 事件流（event flow ）存在三个阶段：**事件捕获阶段、处于目标阶段、事件冒泡阶段。**</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Javascript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>element-ui</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Qcanvas</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/book/328.html" class="sidebar-link"> 从哲学层面浅谈计算机学习方法论</a></li><li><a href="/book/324.html" class="sidebar-link"> 微信游览器，解决安卓和ios自动播放音乐</a></li><li><a href="/book/323.html" class="sidebar-link"> CSS3 animation属性中的steps功能符深入介绍</a></li><li><a href="/book/322.html" aria-current="page" class="active sidebar-link"> 前端搞工程化：从零打造性能检测库「源码 + 视频」</a></li><li><a href="/book/321.html" class="sidebar-link"> 还在看那些老掉牙的性能优化文章么？这些最新性能指标了解下</a></li><li><a href="/book/320.html" class="sidebar-link"> Nginx根据User Agent动态配置root目录适配移动端</a></li><li><a href="/book/307.html" class="sidebar-link"> cat文档内容中搜索字符串输出到文件</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>node</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/book/301.html" class="sidebar-link">从App store下载App的不同版本ipa文件----很多东西也不是越新越好，比如APP——在 iPhone 上尤其如此</a></li><li><a href="/book/294.html" class="sidebar-link">迟子建老师的《一坛猪油》</a></li><li><a href="/book/288.html" class="sidebar-link">文本文档的协同编辑实现</a></li><li><a href="/book/287.html" class="sidebar-link">再见，整洁代码</a></li><li><a href="/book/286.html" class="sidebar-link"> 可以在 Nginx 中运行 JavaScript，厉害了！</a></li><li><a href="/book/284.html" class="sidebar-link"> word中批量调整图片大小</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>electron打包的一些问题</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/book/274.html" class="sidebar-link"> 文件分片代码</a></li><li><a href="/book/273.html" class="sidebar-link"> 重学 JS：为啥 await 不能用在 forEach 中详解</a></li><li><a href="/book/269.html" class="sidebar-link"> Excel函数之王，Vlookup到底怎么用？</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>mysql</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/book/248.html" class="sidebar-link"> 《提问的智慧》精读注解版</a></li><li><a href="/book/199.html" class="sidebar-link"> js监听div的resize事件</a></li><li><a href="/book/198.html" class="sidebar-link"> 引入第三方字体体积太大的问题</a></li><li><a href="/book/195.html" class="sidebar-link"> 多行溢出省略号显示（css/js）实现！</a></li><li><a href="/book/190.html" class="sidebar-link">今天带大家一起来看看下，如何实现“划词高亮”功能。</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Css</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Canvas</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工作中解决的疑难问题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>nginx</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/book/135.html" class="sidebar-link"> 深夜，我偷听到程序员要对session下手</a></li><li><a href="/book/132.html" class="sidebar-link"> 读 《深入浅出webpack》</a></li><li><a href="/book/103.html" class="sidebar-link"> 一道被人轻视的前端面试题</a></li><li><a href="/book/101.html" class="sidebar-link">部分前端面试题参考答案</a></li><li><a href="/book/80.html" class="sidebar-link">SVGDeveloper制作矢量地图教程详解</a></li><li><a href="/book/76.html" class="sidebar-link">VisualStudio2010创建的WCF（.dll）服务第一个应用</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="前端搞工程化-从零打造性能检测库「源码-视频」"><a href="#前端搞工程化-从零打造性能检测库「源码-视频」" class="header-anchor">#</a> 前端搞工程化：从零打造性能检测库「源码 + 视频」</h1> <blockquote><p>工程化体系专栏永远首发自我的 Github，大家可以关注点赞，通常会早于发布各大平台一周时间以上。</p></blockquote> <p>本文涉及到的源码及视频地址：</p> <ul><li>源码</li> <li>视频，因为制作肯定比文字需要的时间多，所以本周才会更新完毕，大家可以先对视频插个眼</li></ul> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>经常有读者问我什么是前端工程化？该怎么开始做前端工程化？</p> <p>聊下来以后得出一些结论：这类读者普遍就职于中小型公司，前端人员个位数，平时疲于开发，团队内部几乎没有基础建设，工具很蛮荒。工程化对于这些读者来说很陌生，基本不知道这到底是什么，或者说认为 Webpack 就是前端工程化的全部了。</p> <p>笔者目前就职于某厂的基础架构组，为百来号前端提供基础服务建设，对于这个领域有些许皮毛经验。因此有了一些想法，前端搞工程化会是笔者今年开坑的一个系列作品，每块内容会以文章 + 源码 + 视频的方式呈现。</p> <p>这个系列的产出适用于以下群体：</p> <ul><li>中小厂前端，基建蛮荒，平时疲于业务，不知道业务外怎么做东西能提高自己的竞争力、丰富简历</li> <li>公司暂时没有做基建计划，只能业余做一些低成本收益高的产品</li> <li>想了解前端工程化</li></ul> <p>需要说明的是产出只会是一个低成本下的最小可用产品，你可以拿来按需增加功能、参考思路或者纯粹当学习一点知识。</p> <h2 id="什么是前端工程化"><a href="#什么是前端工程化" class="header-anchor">#</a> 什么是前端工程化？</h2> <p>因为是该系列第一篇文章，就先来大致说下什么是前端工程化。</p> <p>我的理解是前端工程化大体上可以理解为是做提效工程，从写代码开始的每一步都可以做工程化。比如说你用 IDE 对比记事本写代码的体验及效率肯定是不一样的；比如说 Webpack 等这类工具也是在帮助我们提升开发、构建的效率，其他的工具也就不一一列出了，大家知道意思就好。</p> <p>当然了，今天要聊到的性能检测也是工程化的一部分。毕竟我们需要有个工具去协助找到应用到底在哪块地方存在性能短板，能帮助开发者更快地定位问题，而不是在生产环境中让用户抱怨产品卡顿。</p> <h2 id="为什么需要性能检测"><a href="#为什么需要性能检测" class="header-anchor">#</a> 为什么需要性能检测？</h2> <p>性能优化是很多前端都绕不开的话题，先不说项目是否需要性能优化，面试的时候这类问题是很常见的。</p> <p>但是光会性能优化的手段还是不够的，我们最后还是需要做出前后数据对比才能体现出这次优化的价值到底有多少，毕竟数据的量化在职场中还是相当重要的。老板不知道你具体做的事情，很多东西都得从数据中来看，数据越好看就说明你完成工作的能力越高。</p> <p>想获取性能的前后数据变化，我们肯定得用一些工具来做性能检测。</p> <h2 id="性能该怎么检测"><a href="#性能该怎么检测" class="header-anchor">#</a> 性能该怎么检测？</h2> <p>性能检测的方式有很多：</p> <ul><li>Chrome 自带的开发者工具：Performance</li> <li>Lighthouse 开源工具</li> <li>原生 Performance API</li> <li>各种官方库、插件</li></ul> <p>这些方法各有各的好处，前两种方式简单快捷，能够可视化各类指标，但是很难拿到用户端的数据，毕竟你不大可能让用户去跑这些工具，当然除此之外还有一些很小的缺点，比如说拿不到重定向次数等等。</p> <p>官方库、插件相比前两者来说会逊色很多，并且只提供一部分核心指标。</p> <p>原生 Performance API 存在兼容问题，但是能覆盖到开发生产阶段，并且功能也能覆盖自带的开发者工具：Performance 工具。不仅在开发阶段能了解到项目的性能指标，还能获取用户端的数据，帮助我们更好地制定优化方案。另外能获取的指标也很齐全，因此是此次我们产品的选择。</p> <p>当然了这不是多选一的选择题，我们在开发阶段还是需要将 Performance 工具及 API 结合起来使用，毕竟他们还是有着相辅相成的作用。</p> <h2 id="实战"><a href="#实战" class="header-anchor">#</a> 实战</h2> <p>这是此处产品的源码：地址。</p> <h3 id="一些性能指标"><a href="#一些性能指标" class="header-anchor">#</a> 一些性能指标</h3> <p>在开始实战前，我们还是得来了解一些性能指标，随着时代发展，其实一些老的性能优化文章已经有点过时了。谷歌一直在更新性能优化这块的指标，笔者之前写过一篇文章来讲述当下的最新性能指标有哪些，有兴趣的读者可以先详细的读一下。</p> <p>当然如果你嫌太长不看，可以先通过以下思维导图简单了解一下：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8344e3dde0de4e0ebd817ca9b9c7bb9e~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt=""></p> <p>当然除了这个指标以外，我们还需要获取网络、文件传输、DOM等信息丰富指标内容。</p> <h3 id="performance-使用"><a href="#performance-使用" class="header-anchor">#</a> Performance 使用</h3> <p><code>Performance</code> 接口可以获取到当前页面中与性能相关的信息，并且提供高精度的时间戳，秒杀 <code>Date.now()</code>。首先我们来看下这个 API 的兼容性：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/69d600b8279b445882aaa8ab12927833~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt=""></p> <p>这个百分比其实已经算是兼容度很高了，主流浏览器的版本都能很好的支持。</p> <p>对于 Performance 上 API 具体的讲解文中就不赘述了，有兴趣的可以阅读 MDN 文档，笔者在这里只讲几个后续用到的重要 API。</p> <h4 id="getentriesbytype"><a href="#getentriesbytype" class="header-anchor">#</a> getEntriesByType</h4> <p>这个 API 可以让我们通过传入 <code>type</code> 获取一些相应的信息：</p> <ul><li>frame：事件循环中帧的时间数据。</li> <li>resource：加载应用程序资源的详细网络计时数据</li> <li>mark：<code>performance.mark</code> 调用信息</li> <li>measure：<code>performance.measure</code> 调用信息</li> <li>longtask：长任务（执行时间大于 50ms）信息。这个类型已被废弃（文档未标注，但是在 Chrome 中使用会显示已废弃），我们可以通过别的方式来拿</li> <li>navigation：浏览器文档事件的指标的方法和属性</li> <li>paint：获取 FP 和 FCP 指标</li></ul> <p>最后两个 <code>type</code> 是性能检测中获取指标的关键类型。当然你如果还想分析加载资源相关的信息的话，那可以多加上 <code>resource</code> 类型。</p> <h4 id="performanceobserver"><a href="#performanceobserver" class="header-anchor">#</a> PerformanceObserver</h4> <p><code>PerformanceObserver</code> 也是用来获取一些性能指标的 API，用法如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> perfObserver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entryList</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 信息处理</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 传入需要的 type</span>
perfObserver<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'longtask'</span><span class="token punctuation">,</span> <span class="token literal-property property">buffered</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
复制代码
</code></pre></div><p>结合 <code>getEntriesByType</code> 以及 <code>PerformanceObserver</code>，我们就能获取到所有需要的指标了。</p> <h3 id="上代码"><a href="#上代码" class="header-anchor">#</a> 上代码！</h3> <p>因为已经贴了源码地址，笔者就不贴大段代码上来了，会把主要的从零到一过程梳理一遍。</p> <p>首先我们肯定要设计好用户如何调用 SDK（代指性能检测库）？需要传递哪些参数？如何获取及上报性能指标？</p> <p>一般来说调用 SDK 多是构建一个实例，所以这次我们选择 <code>class</code> 的方式来写。参数的话暂定传入一个 <code>tracker</code> 函数获取各类指标以及 <code>log</code> 变量决定是否打印指标信息，签名如下：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">IPerProps</span> <span class="token punctuation">{</span>
  tracker<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>type<span class="token operator">:</span> IPerDataType<span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> allData<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
  log<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">IPerDataType</span> <span class="token operator">=</span>
  <span class="token operator">|</span> <span class="token string">'navigationTime'</span>
  <span class="token operator">|</span> <span class="token string">'networkInfo'</span>
  <span class="token operator">|</span> <span class="token string">'paintTime'</span>
  <span class="token operator">|</span> <span class="token string">'lcp'</span>
  <span class="token operator">|</span> <span class="token string">'cls'</span>
  <span class="token operator">|</span> <span class="token string">'fid'</span>
  <span class="token operator">|</span> <span class="token string">'tbt'</span>
复制代码
</code></pre></div><p>接下来我们写 <code>class</code> 内部的代码，首先在前文中我们知道了 Performance API 是存在兼容问题的，所以我们需要在调用 Performance 之前判断一下浏览器是否支持：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Per</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>args<span class="token operator">:</span> IPerProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 存储参数</span>
    config<span class="token punctuation">.</span>tracker <span class="token operator">=</span> args<span class="token punctuation">.</span>tracker
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> args<span class="token punctuation">.</span>log <span class="token operator">===</span> <span class="token string">'boolean'</span><span class="token punctuation">)</span> config<span class="token punctuation">.</span>log <span class="token operator">=</span> args<span class="token punctuation">.</span>log
    <span class="token comment">// 判断是否兼容</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSupportPerformance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">This browser doesn't support Performance API</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">isSupportPerformance</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> performance <span class="token operator">=</span> window<span class="token punctuation">.</span>performance
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    performance <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span><span class="token operator">!</span>performance<span class="token punctuation">.</span>getEntriesByType <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span><span class="token operator">!</span>performance<span class="token punctuation">.</span>now <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span><span class="token operator">!</span>performance<span class="token punctuation">.</span>mark
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
复制代码
</code></pre></div><p>以上前置工作完毕以后，就可以开始写获取性能指标数据的代码了。</p> <p>我们首先通过 <code>performance.getEntriesByType('navigation')</code> 来获取关于文档事件的指标</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/36a16c08f0f44dac9f1ab4de36d4923f~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt=""></p> <p>这个 API 还是能拿到挺多事件的时间戳的，如果你想了解这些事件具体含义，可以阅读文档，这里就不复制过来占用篇幅了。</p> <p>看到那么多字段，可能有的读者就晕了，那么多东西我可怎么算指标。其实不需要担心，看完下图结合刚才的文档就行了：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7eb3f8e279fe4c7ab50c2ca3baa924b2~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt=""></p> <p>我们不需要全部利用上获得的字段，重要的指标信息暴露出来即可，照着图和文档依样画葫芦就能得出代码：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getNavigationTime</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> navigation <span class="token operator">=</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span><span class="token function">getEntriesByType</span><span class="token punctuation">(</span><span class="token string">'navigation'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>navigation<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> timing <span class="token operator">=</span> navigation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">as</span> PerformanceNavigationTiming
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//   解构出来的字段，太长不贴</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span> <span class="token operator">=</span> timing

      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        redirect<span class="token operator">:</span> <span class="token punctuation">{</span>
          count<span class="token operator">:</span> redirectCount<span class="token punctuation">,</span>
          time<span class="token operator">:</span> redirectEnd <span class="token operator">-</span> redirectStart<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        appCache<span class="token operator">:</span> domainLookupStart <span class="token operator">-</span> fetchStart<span class="token punctuation">,</span>
        <span class="token comment">// dns lookup time</span>
        dnsTime<span class="token operator">:</span> domainLookupEnd <span class="token operator">-</span> domainLookupStart<span class="token punctuation">,</span>
        <span class="token comment">// handshake end - handshake start time</span>
        <span class="token constant">TCP</span><span class="token operator">:</span> connectEnd <span class="token operator">-</span> connectStart<span class="token punctuation">,</span>
        <span class="token comment">// HTTP head size</span>
        headSize<span class="token operator">:</span> transferSize <span class="token operator">-</span> encodedBodySize <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span>
        responseTime<span class="token operator">:</span> responseEnd <span class="token operator">-</span> responseStart<span class="token punctuation">,</span>
        <span class="token comment">// Time to First Byte</span>
        <span class="token constant">TTFB</span><span class="token operator">:</span> responseStart <span class="token operator">-</span> requestStart<span class="token punctuation">,</span>
        <span class="token comment">// fetch resource time</span>
        fetchTime<span class="token operator">:</span> responseEnd <span class="token operator">-</span> fetchStart<span class="token punctuation">,</span>
        <span class="token comment">// Service work response time</span>
        workerTime<span class="token operator">:</span> workerStart <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> responseEnd <span class="token operator">-</span> workerStart <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        domReady<span class="token operator">:</span> domContentLoadedEventEnd <span class="token operator">-</span> fetchStart<span class="token punctuation">,</span>
        <span class="token comment">// DOMContentLoaded time</span>
        <span class="token constant">DCL</span><span class="token operator">:</span> domContentLoadedEventEnd <span class="token operator">-</span> domContentLoadedEventStart<span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
复制代码
</code></pre></div><p>大家可以发现以上获得的指标中有不少是和网络有关系的，因此我们还需要结合网络环境来分析，获取网络环境信息很方便，以下是代码：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getNetworkInfo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'connection'</span> <span class="token keyword">in</span> window<span class="token punctuation">.</span>navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> connection <span class="token operator">=</span> window<span class="token punctuation">.</span>navigator<span class="token punctuation">[</span><span class="token string">'connection'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> effectiveType<span class="token punctuation">,</span> downlink<span class="token punctuation">,</span> rtt<span class="token punctuation">,</span> saveData <span class="token punctuation">}</span> <span class="token operator">=</span> connection
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token comment">// 网络类型，4g 3g 这些</span>
      effectiveType<span class="token punctuation">,</span>
      <span class="token comment">// 网络下行速度</span>
      downlink<span class="token punctuation">,</span>
      <span class="token comment">// 发送数据到接受数据的往返时间</span>
      rtt<span class="token punctuation">,</span>
      <span class="token comment">// 打开/请求数据保护模式</span>
      saveData<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
复制代码
</code></pre></div><p>拿完以上的指标之后，我们需要用到 <code>PerformanceObserver</code> 来拿一些核心体验（性能）指标了。比如说 FP、FCP、FID 等等，内容就包括在我们上文中看过的思维导图中：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a222251ac9a1421dbabc614110627c52~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt=""></p> <p>在这之前我们需要先了解一个注意事项：页面是有可能在处于后台的情况下加载的，因此这种情况下获取的指标是不准确的。所以我们需要忽略掉这种情况，通过以下代码来存储一个变量，在获取指标的时候比较一下时间戳来判断是否处于后台中：</p> <div class="language-ts extra-class"><pre class="language-ts"><code>document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">'visibilitychange'</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// @ts-ignore</span>
    hiddenTime <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>hiddenTime<span class="token punctuation">,</span> event<span class="token punctuation">.</span>timeStamp<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> once<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
复制代码
</code></pre></div><p>接下来是获取指标的代码，因为他们获取方式大同小异，所以先把获取方法封装一下：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 封装一下 PerformanceObserver，方便后续调用</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getObserver</span> <span class="token operator">=</span> <span class="token punctuation">(</span>type<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> cb<span class="token operator">:</span> IPerCallback<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> perfObserver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span>entryList<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">cb</span><span class="token punctuation">(</span>entryList<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  perfObserver<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">,</span> buffered<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
复制代码
</code></pre></div><p>我们先来获取 FP 及 FCP 指标：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getPaintTime</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> data<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">getObserver</span><span class="token punctuation">(</span><span class="token string">'paint'</span><span class="token punctuation">,</span> entries <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    entries<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>entry <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      data<span class="token punctuation">[</span>entry<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> entry<span class="token punctuation">.</span>startTime
      <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'first-contentful-paint'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">getLongTask</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>startTime<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> data
<span class="token punctuation">}</span>
复制代码
</code></pre></div><p>拿到的数据结构长这样：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6ba89084c5bc48848db49b891d62f970~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt=""></p> <p>需要注意的是在拿到 FCP 指标以后需要同步开始获取 longtask 的时间，这是因为后续的 TBT 指标需要使用 longtask 来计算。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getLongTask</span> <span class="token operator">=</span> <span class="token punctuation">(</span>fcp<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">getObserver</span><span class="token punctuation">(</span><span class="token string">'longtask'</span><span class="token punctuation">,</span> entries <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    entries<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>entry <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// get long task time in fcp -&gt; tti</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token string">'self'</span> <span class="token operator">||</span> entry<span class="token punctuation">.</span>startTime <span class="token operator">&lt;</span> fcp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// long tasks mean time over 50ms</span>
      <span class="token keyword">const</span> blockingTime <span class="token operator">=</span> entry<span class="token punctuation">.</span>duration <span class="token operator">-</span> <span class="token number">50</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>blockingTime <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> tbt <span class="token operator">+=</span> blockingTime
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
复制代码
</code></pre></div><p>接下来我们来拿 FID 指标，以下是代码：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getFID</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">getObserver</span><span class="token punctuation">(</span><span class="token string">'first-input'</span><span class="token punctuation">,</span> entries <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    entries<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>entry <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>startTime <span class="token operator">&lt;</span> hiddenTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">logIndicator</span><span class="token punctuation">(</span><span class="token string">'FID'</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span>processingStart <span class="token operator">-</span> entry<span class="token punctuation">.</span>startTime<span class="token punctuation">)</span>
        <span class="token comment">// TBT is in fcp -&gt; tti</span>
        <span class="token comment">// This data may be inaccurate, because fid &gt;= tti</span>
        <span class="token function">logIndicator</span><span class="token punctuation">(</span><span class="token string">'TBT'</span><span class="token punctuation">,</span> tbt<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
复制代码
</code></pre></div><p>FID 的指标数据长这样，需要用户交互才会触发：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8b4d85a6e8654388930b8ed499f925dc~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt=""></p> <p>在获取 FID 指标以后，我们也去拿了 TBT 指标，但是拿到的数据不一定是准确的。因为 TBT 指标的含义是在 FCP 及 TTI 指标之间的长任务阻塞时间之和，但目前好像没有一个好的方式来获取 TTI 指标数据，所以就用 FID 暂代了。</p> <p>最后是 CLS 和 LCP 指标，大同小异就贴在一起了：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getLCP</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">getObserver</span><span class="token punctuation">(</span><span class="token string">'largest-contentful-paint'</span><span class="token punctuation">,</span> entries <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    entries<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>entry <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>startTime <span class="token operator">&lt;</span> hiddenTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> startTime<span class="token punctuation">,</span> renderTime<span class="token punctuation">,</span> size <span class="token punctuation">}</span> <span class="token operator">=</span> entry
        <span class="token function">logIndicator</span><span class="token punctuation">(</span><span class="token string">'LCP Update'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          time<span class="token operator">:</span> renderTime <span class="token operator">|</span> startTime<span class="token punctuation">,</span>
          size<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getCLS</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">getObserver</span><span class="token punctuation">(</span><span class="token string">'layout-shift'</span><span class="token punctuation">,</span> entries <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> cls <span class="token operator">=</span> <span class="token number">0</span>
    entries<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>entry <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">.</span>hadRecentInput<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cls <span class="token operator">+=</span> entry<span class="token punctuation">.</span>value
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">logIndicator</span><span class="token punctuation">(</span><span class="token string">'CLS Update'</span><span class="token punctuation">,</span> cls<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
复制代码
</code></pre></div><p>拿到的数据结构长这样：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/966e5ca74ebf422eb1747c99489e8f82~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="截屏2021-01-17下午7.37.33"> <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f2c4466fd2464c63b90c2428aafdbbfe~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="截屏2021-01-17下午7.37.14"></p> <p>另外这两个指标还和别的不大一样，并不是一成不变的。一旦有新的数据符合指标要求，就会更新。</p> <p>以上就是我们需要获取的所有性能指标了，当然光获取到指标肯定是不够，还需要暴露每个数据给用户，对于这种统一操作，我们需要封装一个工具函数出来：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 打印数据</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">logIndicator</span> <span class="token operator">=</span> <span class="token punctuation">(</span>type<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> data<span class="token operator">:</span> IPerData<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">tracker</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>log<span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token comment">// 让 log 好看点</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">%cPer%c</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">type</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token string">'background: #606060; color: white; padding: 1px 10px; border-top-left-radius: 3px; border-bottom-left-radius: 3px;'</span><span class="token punctuation">,</span>
    <span class="token string">'background: #1475b2; color: white; padding: 1px 10px; border-top-right-radius: 3px;border-bottom-right-radius: 3px;'</span><span class="token punctuation">,</span>
    data
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span>type<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> data<span class="token operator">:</span> IPerData<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> currentType <span class="token operator">=</span> typeMap<span class="token punctuation">[</span>type<span class="token punctuation">]</span>
  allData<span class="token punctuation">[</span>currentType<span class="token punctuation">]</span> <span class="token operator">=</span> data
  <span class="token comment">// 如果用户传了回调函数，那么每次在新获取指标以后就把相关信息暴露出去</span>
  config<span class="token punctuation">.</span>tracker <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span><span class="token function">tracker</span><span class="token punctuation">(</span>currentType<span class="token punctuation">,</span> data<span class="token punctuation">,</span> allData<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
复制代码
</code></pre></div><p>封装好函数以后，我们可以这样调用：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">logIndicator</span><span class="token punctuation">(</span><span class="token string">'FID'</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span>processingStart <span class="token operator">-</span> entry<span class="token punctuation">.</span>startTime<span class="token punctuation">)</span>
复制代码
</code></pre></div><p>在这里为止我们 SDK 的大体内容已经完成了，我们可以按需添加一些小功能，比如说获取指标分数。</p> <p>指标分数是官方给的一些建议，你可以在官方 Blog 或者我的文章中看到定义的数据。</p> <p>代码不复杂，我们就以获取 FCP 指标的分数为例演示一下代码：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> scores<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  fcp<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">4000</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  lcp<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2500</span><span class="token punctuation">,</span> <span class="token number">4500</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  fid<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  tbt<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  cls<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> scoreLevel <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'good'</span><span class="token punctuation">,</span> <span class="token string">'needsImprovement'</span><span class="token punctuation">,</span> <span class="token string">'poor'</span><span class="token punctuation">]</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getScore</span> <span class="token operator">=</span> <span class="token punctuation">(</span>type<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> score <span class="token operator">=</span> scores<span class="token punctuation">[</span>type<span class="token punctuation">]</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> score<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">&lt;=</span> score<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> scoreLevel<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> scoreLevel<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
复制代码
</code></pre></div><p>首先是获取分数相关的工具函数，这块反正就是看着官方建议照抄，然后我们只需要在刚才获取指标的地方多加一句代码即可：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getPaintTime</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">getObserver</span><span class="token punctuation">(</span><span class="token string">'paint'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>entries<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    entries<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> time <span class="token operator">=</span> entry<span class="token punctuation">.</span>startTime
      <span class="token keyword">const</span> name <span class="token operator">=</span> entry<span class="token punctuation">.</span>name
      <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">'first-contentful-paint'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">getLongTask</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span>
        <span class="token function">logIndicator</span><span class="token punctuation">(</span><span class="token string">'FCP'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          time<span class="token punctuation">,</span>
          score<span class="token operator">:</span> <span class="token function">getScore</span><span class="token punctuation">(</span><span class="token string">'fcp'</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">logIndicator</span><span class="token punctuation">(</span><span class="token string">'FP'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          time<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
复制代码
</code></pre></div><p>结束了，有兴趣的可以来这里读一下源码，反正也没几行。</p> <h2 id="最后"><a href="#最后" class="header-anchor">#</a> 最后</h2> <p>文章周末写的，略显仓促，如有出错请斧正，同时也欢迎大家一起探讨问题。</p> <p>想看更多文章可以关注我的 Github 或者进群一起聊聊前端工程化。</p> <p>.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}
文章来源：https://juejin.cn/post/6919295789630455815</p> <!----></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/book/323.html" class="prev">
         CSS3 animation属性中的steps功能符深入介绍
      </a></span> <span class="next"><a href="/book/321.html">
         还在看那些老掉牙的性能优化文章么？这些最新性能指标了解下
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><section class="side-anchor"><ul style="display:none;"></ul></section></div></div>
    <script src="/book/assets/js/app.a5076a9c.js" defer></script><script src="/book/assets/js/3.0d5fb1e8.js" defer></script><script src="/book/assets/js/115.35834155.js" defer></script><script src="/book/assets/js/4.4c5f7830.js" defer></script>
  </body>
</html>
